<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEREGRINE LIVE</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Poppins Font (More Professional) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- HLS.js for Jio TV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.5.8/hls.min.js"></script>
    <!-- Shaka Player for Zee TV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/controls.min.css" crossorigin="anonymous" />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.4s, color 0.4s;
        }
        .dark-theme {
            background-color: #0c0d12;
            color: #e0e6f0;
        }
        .light-theme {
            background-color: #f0f2f5;
            color: #1a202c;
        }
        /* Gradient for professional look */
        .header-bg {
            background-image: linear-gradient(to right, #1a273a, #131b28);
            color: #fff;
        }
        .light-theme .header-bg {
            background-image: linear-gradient(to right, #6b88c4, #4a639d);
            color: #fff;
        }
        .tab-button {
            transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
        }
        .tab-button.active {
            background-color: #3b82f6 !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }
        .dark-theme .channel-card {
            background-color: #1a1e26;
            transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
        }
        .dark-theme .channel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            background-color: #21262d;
        }
        .light-theme .channel-card {
            background-color: #ffffff;
            transition: transform 0.3s, box-shadow 0.3s, background-color 0.3s;
        }
        .light-theme .channel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            background-color: #f7f9fd;
        }
        .quality-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em;
        }
    </style>
</head>

<body class="dark-theme">
    <div class="min-h-screen p-4 flex flex-col items-center">

        <!-- Header -->
        <header class="w-full max-w-5xl p-6 mb-8 flex flex-col md:flex-row items-center justify-between rounded-2xl shadow-xl header-bg">
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-wider mb-4 md:mb-0 text-white">PEREGRINE LIVE</h1>
            <div class="flex space-x-4">
                <button id="theme-toggle" class="bg-gray-700 text-white font-medium py-2 px-5 rounded-full hover:bg-gray-600 transition-colors shadow-lg">
                    <i class="fas fa-moon"></i> Theme
                </button>
                <button id="about-button" class="bg-gray-700 text-white font-medium py-2 px-5 rounded-full hover:bg-gray-600 transition-colors shadow-lg">
                    <i class="fas fa-info-circle"></i> About
                </button>
            </div>
        </header>

        <!-- Video Player Section -->
        <main class="w-full max-w-5xl mb-8 bg-[#1a1e26] rounded-2xl shadow-2xl p-4 md:p-6">
            <div id="video-container" class="shaka-video-container relative aspect-video w-full rounded-xl overflow-hidden shadow-inner-lg">
                <video id="video" class="w-full h-full object-cover" poster="https://placehold.co/1280x720/1a202c/6b7280?text=Select+a+channel+to+stream" controls autoplay></video>
                <div id="player-overlay" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center text-white text-xl font-bold transition-opacity duration-300">Select a channel to start streaming.</div>
            </div>
            <p id="stream-title" class="text-center text-lg md:text-xl font-semibold mt-4 text-[#8b949e]"></p>
        </main>

        <!-- Quality Selector (Initially hidden) -->
        <div id="quality-selector-container" class="w-full max-w-2xl p-3 rounded-xl mb-6 bg-[#1a1e26] shadow-xl hidden">
            <label for="quality-selector" class="block text-sm font-medium text-[#8b949e] mb-2">Select Quality:</label>
            <select id="quality-selector" class="w-full p-3 rounded-lg bg-[#21262d] text-[#c9d1d9] quality-select focus:outline-none focus:ring-2 focus:ring-blue-500">
            </select>
        </div>

        <!-- Tabs Section -->
        <div class="w-full max-w-5xl mb-8 flex flex-wrap justify-center space-x-2 md:space-x-4 p-2 rounded-xl bg-[#1a1e26] shadow-inner">
            <button id="jio-tab" class="tab-button bg-[#21262d] text-[#e0e6f0] font-medium py-3 px-6 rounded-full transition-all duration-300 active">Jio TV</button>
            <button id="zee-tab" class="tab-button bg-[#21262d] text-[#e0e6f0] font-medium py-3 px-6 rounded-full transition-all duration-300">Zee TV</button>
            <button id="pirate-tab" class="tab-button bg-[#21262d] text-[#e0e6f0] font-medium py-3 px-6 rounded-full transition-all duration-300">Pirate TV</button>
            <button id="highlights-tab" class="tab-button bg-[#21262d] text-[#e0e6f0] font-medium py-3 px-6 rounded-full transition-all duration-300">Highlights</button>
        </div>

        <!-- Channel List -->
        <div id="channel-list" class="w-full max-w-5xl grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
            <div id="loading-spinner" class="col-span-full text-center p-10 hidden">
                <i class="fas fa-spinner fa-spin fa-3x text-blue-500"></i>
                <p class="mt-4 text-xl font-medium">Loading channels...</p>
            </div>
            <!-- Channel cards will be populated here by JavaScript -->
        </div>

        <!-- About Modal (Hidden by default) -->
        <div id="about-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
            <div class="modal-content bg-[#1a1e26] p-8 rounded-2xl shadow-2xl w-full max-w-xl relative">
                <button id="close-modal-button" class="absolute top-4 right-4 text-3xl font-bold text-[#c9d1d9] hover:text-[#58a6ff] transition-colors">&times;</button>
                <h2 class="text-3xl font-bold mb-4 text-white">About PEREGRINE LIVE</h2>
                <p class="text-gray-400">यह एक सिंपल लाइव स्ट्रीमिंग वेबसाइट है। इसका मुख्य उद्देश्य HLS (Jio TV) और DASH (Zee TV) दोनों प्रकार की स्ट्रीम को एक ही जगह पर चलाना है।</p>
                <p class="text-gray-400 mt-4"><b>Disclaimer:</b> यह वेबसाइट सिर्फ educational और demonstration purposes के लिए बनाई गई है। इसमें दी गई सभी स्ट्रीम्स पब्लिक डोमेन में उपलब्ध हैं। किसी भी copyright infringement के लिए developer जिम्मेदार नहीं है।</p>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const state = {
                activeTab: 'jio-tv',
                currentHls: null,
                currentShakaPlayer: null
            };

            const elements = {
                body: document.body,
                themeToggle: document.getElementById('theme-toggle'),
                aboutButton: document.getElementById('about-button'),
                aboutModal: document.getElementById('about-modal'),
                closeModalButton: document.getElementById('close-modal-button'),
                video: document.getElementById('video'),
                streamTitle: document.getElementById('stream-title'),
                jioTab: document.getElementById('jio-tab'),
                zeeTab: document.getElementById('zee-tab'),
                pirateTab: document.getElementById('pirate-tab'),
                highlightsTab: document.getElementById('highlights-tab'),
                channelList: document.getElementById('channel-list'),
                playerOverlay: document.getElementById('player-overlay'),
                qualitySelectorContainer: document.getElementById('quality-selector-container'),
                qualitySelector: document.getElementById('quality-selector'),
                loadingSpinner: document.getElementById('loading-spinner')
            };

            // Using updated, working URLs
            const jioTvDataUrl = 'https://raw.githubusercontent.com/rocket12-18/dineshbhai/refs/heads/main/jd.m3u';
            const zeeTvDataUrl = 'https://raw.githubusercontent.com/rocket12-18/dineshbhai/refs/heads/main/zee.json';
            
            // --- Theme Change Logic ---
            const currentTheme = localStorage.getItem('theme') || 'dark-theme';
            elements.body.className = currentTheme;

            elements.themeToggle.addEventListener('click', () => {
                const newTheme = elements.body.classList.contains('dark-theme') ? 'light-theme' : 'dark-theme';
                elements.body.className = newTheme;
                localStorage.setItem('theme', newTheme);
                // Update icon
                if (newTheme === 'dark-theme') {
                    elements.themeToggle.innerHTML = '<i class="fas fa-moon"></i> Theme';
                } else {
                    elements.themeToggle.innerHTML = '<i class="fas fa-sun"></i> Theme';
                }
            });

            // Set initial icon
            if (currentTheme === 'light-theme') {
                elements.themeToggle.innerHTML = '<i class="fas fa-sun"></i> Theme';
            }

            // --- About Modal Logic ---
            elements.aboutButton.addEventListener('click', () => {
                elements.aboutModal.classList.remove('hidden');
            });
            elements.closeModalButton.addEventListener('click', () => {
                elements.aboutModal.classList.add('hidden');
            });

            elements.aboutModal.addEventListener('click', (e) => {
                if (e.target === elements.aboutModal) {
                    elements.aboutModal.classList.add('hidden');
                }
            });

            // --- Player Management ---
            const stopPlayer = () => {
                if (state.currentHls) {
                    state.currentHls.destroy();
                    state.currentHls = null;
                }
                if (state.currentShakaPlayer) {
                    state.currentShakaPlayer.destroy();
                    state.currentShakaPlayer = null;
                }
                elements.video.src = '';
                elements.video.removeAttribute('shaka-controls');
                elements.video.load();
                elements.streamTitle.textContent = '';
                elements.playerOverlay.classList.remove('hidden');
                elements.qualitySelectorContainer.classList.add('hidden');
            };

            const initJioPlayer = (url, title) => {
                stopPlayer();
                if (Hls.isSupported()) {
                    elements.playerOverlay.classList.add('hidden');
                    state.currentHls = new Hls();
                    state.currentHls.loadSource(url);
                    state.currentHls.attachMedia(elements.video);
                    state.currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
                        elements.video.play();
                    });

                    // Quality Selector
                    elements.qualitySelectorContainer.classList.remove('hidden');
                    state.currentHls.on(Hls.Events.LEVEL_LOADED, () => {
                        const levels = state.currentHls.levels;
                        elements.qualitySelector.innerHTML = '';
                        levels.forEach((level, index) => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = `${level.height}p @ ${Math.round(level.bitrate / 1000)} kbps`;
                            elements.qualitySelector.appendChild(option);
                        });
                        elements.qualitySelector.value = state.currentHls.currentLevel;
                    });

                    elements.qualitySelector.onchange = (e) => {
                        state.currentHls.currentLevel = parseInt(e.target.value, 10);
                    };

                } else if (elements.video.canPlayType('application/vnd.apple.mpegurl')) {
                    elements.playerOverlay.classList.add('hidden');
                    elements.video.src = url;
                    elements.video.addEventListener('loadedmetadata', () => {
                        elements.video.play();
                    });
                } else {
                    elements.streamTitle.textContent = "Error: HLS is not supported on this browser.";
                }
                elements.streamTitle.textContent = title;
            };

            const initZeePlayer = (mpdUrl, clearkey, title) => {
                stopPlayer();
                if (!shaka || !shaka.Player.isSupported()) {
                    elements.streamTitle.textContent = "Error: Shaka Player is not supported on this browser.";
                    return;
                }
                
                elements.playerOverlay.classList.add('hidden');
                
                shaka.log.setLevel(shaka.log.Level.V1);
                
                const ui = elements.video['ui'];
                const controls = ui.getControls();
                state.currentShakaPlayer = controls.getPlayer();

                const config = {
                    drm: {
                        clearKeys: clearkey
                    }
                };
                
                state.currentShakaPlayer.configure(config);

                state.currentShakaPlayer.load(mpdUrl).then(() => {
                    elements.streamTitle.textContent = title;
                    elements.qualitySelectorContainer.classList.add('hidden');
                }).catch((error) => {
                    console.error('Error while loading stream:', error);
                    elements.streamTitle.textContent = `Error: Could not load stream. ${error.code} - ${error.message}`;
                    elements.playerOverlay.classList.remove('hidden');
                });
            };

            const createChannelCard = (name, logoUrl, clickHandler) => {
                const card = document.createElement('div');
                card.className = "group channel-card flex flex-col items-center p-4 rounded-xl shadow-md cursor-pointer transition-all duration-300";
                card.onclick = clickHandler;

                const img = document.createElement('img');
                img.src = logoUrl || 'https://placehold.co/150x150/1a202c/6b7280?text=No+Logo';
                img.className = "w-24 h-24 md:w-32 md:h-32 rounded-lg mb-2 object-contain transition-transform duration-300 group-hover:scale-105";
                img.alt = name;

                const nameEl = document.createElement('span');
                nameEl.className = "text-center text-sm md:text-base font-semibold truncate w-full group-hover:text-blue-500 transition-colors";
                nameEl.textContent = name;

                card.appendChild(img);
                card.appendChild(nameEl);
                return card;
            };

            // --- Tab Switching Logic ---
            const switchTab = (tabName) => {
                if (state.activeTab === tabName) return;
                state.activeTab = tabName;

                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`${tabName}-tab`).classList.add('active');
                elements.channelList.innerHTML = '';
                stopPlayer();
                loadChannels(tabName);
            };

            const loadChannels = async (tabName) => {
                elements.loadingSpinner.classList.remove('hidden');
                try {
                    let channels = [];
                    switch (tabName) {
                        case 'jio-tv':
                            const jioResponse = await fetch(jioTvDataUrl);
                            const jioData = await jioResponse.text();
                            channels = parseM3uData(jioData);
                            break;
                        case 'zee-tv':
                            const zeeResponse = await fetch(zeeTvDataUrl);
                            const zeeData = await zeeResponse.json();
                            channels = zeeData.channels;
                            break;
                        case 'pirate-tv':
                            channels = [{
                                name: 'Public Domain',
                                logo: 'https://placehold.co/150x150/21262d/c9d1d9?text=Public',
                                url: 'https://cdn-1.vidsrc.me/hls/rJ98LpP7/playlist.m3u8'
                            }];
                            break;
                        case 'highlights':
                            channels = [{
                                name: 'Big Buck Bunny',
                                logo: 'https://placehold.co/150x150/21262d/c9d1d9?text=Movie',
                                url: 'https://bitdash-a.akamaihd.net/content/sintel/hls/playlist.m3u8'
                            }];
                            break;
                    }

                    elements.channelList.innerHTML = '';
                    channels.forEach(channel => {
                        const card = createChannelCard(
                            channel.name, 
                            channel.logo, 
                            () => {
                                if (tabName === 'jio-tv' || tabName === 'pirate-tv' || tabName === 'highlights') {
                                    initJioPlayer(channel.url, channel.name);
                                } else if (tabName === 'zee-tv') {
                                    const clearKeyObject = {};
                                    if (channel.clearkey) {
                                        clearKeyObject[channel.clearkey.keyId] = channel.clearkey.key;
                                    }
                                    initZeePlayer(channel.mpd, clearKeyObject, channel.name);
                                }
                            }
                        );
                        elements.channelList.appendChild(card);
                    });
                } catch (error) {
                    console.error("Error loading channels:", error);
                    elements.streamTitle.textContent = "Error: Failed to load channels. Please check the network.";
                } finally {
                    elements.loadingSpinner.classList.add('hidden');
                }
            };

            // --- Helper to parse M3U data ---
            const parseM3uData = (data) => {
                const lines = data.split('\n');
                const channels = [];
                let currentChannel = {};

                lines.forEach(line => {
                    if (line.startsWith('#EXTINF')) {
                        const nameMatch = /tvg-name="([^"]+)"/.exec(line) || /group-title="([^"]+)"/.exec(line);
                        const logoMatch = /tvg-logo="([^"]+)"/.exec(line);
                        const name = nameMatch ? nameMatch[1] : 'Unknown';
                        const logo = logoMatch ? logoMatch[1] : null;
                        currentChannel = { name, logo };
                    } else if (line.trim() !== '' && !line.startsWith('#')) {
                        currentChannel.url = line.trim();
                        channels.push(currentChannel);
                        currentChannel = {};
                    }
                });
                return channels;
            };

            // --- Event Listeners for tabs ---
            elements.jioTab.addEventListener('click', () => switchTab('jio-tv'));
            elements.zeeTab.addEventListener('click', () => switchTab('zee-tv'));
            elements.pirateTab.addEventListener('click', () => switchTab('pirate-tv'));
            elements.highlightsTab.addEventListener('click', () => switchTab('highlights'));

            // Initial load
            loadChannels('jio-tv');
            
            // Shaka Player UI initialization
            const initShakaUI = () => {
              if (shaka && shaka.ui) {
                const videoElement = document.getElementById('video');
                const ui = videoElement['ui'];
                if (ui) ui.destroy();
                shaka.ui.Controls.create(
                    new shaka.Player(videoElement),
                    videoElement
                );
              }
            };
            initShakaUI();
        });
    </script>
</body>
</html>
