<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peregrine Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
        }
        .tab-button {
            transition: all 0.2s;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col items-center">
    <div class="container mx-auto p-4 md:p-8 w-full">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500 rounded-lg p-2">PEREGRINE LIVE</h1>
            <div class="relative w-full sm:w-1/2 md:w-1/3">
                <input type="text" placeholder="चैनल खोजें..." class="search-bar w-full py-2 px-4 rounded-full bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-lg" />
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs flex flex-wrap justify-center sm:justify-start gap-2 mb-6 p-2 rounded-xl bg-gray-800 shadow-inner">
            <button class="tab-button bg-gray-700 hover:bg-gray-600 text-sm md:text-base font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-tab="jio-tv">Jio TV</button>
            <button class="tab-button bg-gray-700 hover:bg-gray-600 text-sm md:text-base font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-tab="jiostar">JioStar</button>
            <button class="tab-button bg-gray-700 hover:bg-gray-600 text-sm md:text-base font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-tab="zee-network">Zee Network</button>
            <button class="tab-button bg-gray-700 hover:bg-gray-600 text-sm md:text-base font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-tab="fancode">FanCode</button>
            <button class="tab-button bg-gray-700 hover:bg-gray-600 text-sm md:text-base font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-tab="pirates-tv">Pirates TV</button>
            <button class="tab-button bg-gray-700 hover:bg-gray-600 text-sm md:text-base font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-tab="others">Others</button>
            <button class="tab-button bg-gray-700 hover:bg-gray-600 text-sm md:text-base font-semibold py-2 px-4 rounded-full shadow-md transition-colors duration-200" data-tab="n-stream">N Stream</button>
        </div>

        <!-- Content Display Area -->
        <div id="content-display" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 p-4 rounded-xl bg-gray-800 shadow-lg w-full">
            <!-- Channels will be displayed here -->
            <p class="text-center text-gray-400 p-4">चैनल लोड हो रहे हैं...</p>
        </div>

        <!-- N Stream Player Section -->
        <div id="n-stream-player-section" class="hidden flex-col items-center justify-center p-6 bg-gray-800 rounded-xl shadow-lg w-full max-w-xl mx-auto space-y-4">
            <h2 class="text-xl font-bold">अपना स्ट्रीम चलाएं</h2>
            <select id="stream-type-select" class="w-full py-2 px-4 rounded-full bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md">
                <option value="HLS">HLS (.m3u8)</option>
                <option value="DASH">DASH (.mpd)</option>
            </select>
            <input type="text" id="stream-url-input" placeholder="स्ट्रीम URL डालें" class="w-full py-2 px-4 rounded-full bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md" />
            
            <div id="drm-controls" class="hidden flex-col w-full space-y-4">
                <h3 class="text-lg font-semibold mt-2">DRM Controls (Optional)</h3>
                <input type="text" id="clearkey-id-input" placeholder="ClearKey ID (e.g., 400131994b445d8c8817202248760fda)" class="w-full py-2 px-4 rounded-full bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md" />
                <input type="text" id="clearkey-key-input" placeholder="ClearKey Key (e.g., 2d56cb6f07a75b9aff165d534ae2bfc4)" class="w-full py-2 px-4 rounded-full bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md" />
                <input type="text" id="drm-license-url-input" placeholder="DRM लाइसेंस URL (Widevine/PlayReady)" class="w-full py-2 px-4 rounded-full bg-gray-700 text-gray-200 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-md" />
            </div>
            
            <button id="play-n-stream-btn" class="w-full py-3 px-6 rounded-full bg-green-500 hover:bg-green-600 text-white font-bold transition-colors duration-200 shadow-md">स्ट्रीम चलाएं</button>
        </div>

        <!-- Custom Message Box -->
        <div id="custom-message-box" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="custom-message-text" class="text-white mb-4"></p>
                <button onclick="document.getElementById('custom-message-box').style.display='none'" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200">ठीक है</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        const contentDisplay = document.getElementById('content-display');
        const tabButtons = document.querySelectorAll('.tab-button');
        const nStreamPlayerSection = document.getElementById('n-stream-player-section');
        const streamTypeSelect = document.getElementById('stream-type-select');
        const streamUrlInput = document.getElementById('stream-url-input');
        const drmControls = document.getElementById('drm-controls');
        const clearkeyIdInput = document.getElementById('clearkey-id-input');
        const clearkeyKeyInput = document.getElementById('clearkey-key-input');
        const drmLicenseUrlInput = document.getElementById('drm-license-url-input');
        const playNStreamBtn = document.getElementById('play-n-stream-btn');
        let currentLoadedChannels = [];
        
        // Cloudflare Worker URL
        const WORKER_BASE_URL = 'https://irplus.24862486gill.workers.dev';
        
        // New Player Website URL
        const PLAYER_SITE_URL = 'https://greenhck.github.io/Tnt-sports-1/';
        
        const tabDataUrls = {
            'zee-network': 'zee-network',
            'fancode': 'fancode',
            'pirates-tv': 'pirates-tv',
            'jio-tv': 'jio-tv',
            'jiostar': 'jiostar',
            'others': 'others',
        };

        // Show custom message box instead of alert()
        function showUserMessage(message) {
            document.getElementById('custom-message-text').innerText = message;
            document.getElementById('custom-message-box').style.display = 'flex';
        }

        // Channel display functions
        function displayChannels(channels) {
            currentLoadedChannels = channels;
            contentDisplay.innerHTML = '';
            if (channels.length === 0) {
                contentDisplay.innerHTML = `<p class="text-center text-gray-400 p-4">कोई चैनल/मैच नहीं मिला।</p>`;
                return;
            }
            channels.forEach(channel => {
                const urlParams = new URLSearchParams({
                    streamUrl: channel.mpd || channel.m3u8,
                    name: channel.name,
                    source: channel.source,
                    showAd: "true"
                });

                const channelCard = document.createElement('a');
                channelCard.href = `${PLAYER_SITE_URL}?${urlParams.toString()}`;
                channelCard.target = '_blank';
                channelCard.classList.add('channel-card', 'bg-gray-800', 'rounded-lg', 'overflow-hidden', 'shadow-lg', 'transform', 'transition-transform', 'duration-200', 'hover:-translate-y-1', 'hover:shadow-2xl');
                channelCard.innerHTML = `
                    <img src="${channel.logo || 'https://placehold.co/200x150/2d3748/a0aec0?text=No+Image'}" alt="${channel.name}" class="w-full h-32 sm:h-40 object-cover">
                    <h3 class="p-2 sm:p-3 text-sm sm:text-base font-semibold text-center truncate">${channel.name}</h3>
                `;
                contentDisplay.appendChild(channelCard);
            });
        }
        
        async function parseM3U(m3uContent, source) {
            const lines = m3uContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const channels = [];
            let currentChannel = {};
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.startsWith('#EXTINF:')) {
                    currentChannel = {
                        name: 'Unknown Channel',
                        logo: '',
                        mpd: null,
                        m3u8: null,
                        clearkey: null,
                        cookie: null,
                        source: source
                    };
                    const nameMatch = line.match(/,(.+)$/);
                    currentChannel.name = nameMatch ? nameMatch[1].trim() : 'Unknown Channel';
                    const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                    currentChannel.logo = logoMatch ? logoMatch[1] : '';
                    let urlFound = false;
                    let j = i + 1;
                    while (j < lines.length && !urlFound) {
                        const subLine = lines[j];
                        if (subLine.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                            const clearkeyMatch = subLine.match(/license_key=([^:]+):([a-f0-9]+)/);
                            if (clearkeyMatch) {
                                currentChannel.clearkey = { keyId: clearkeyMatch[1], key: clearkeyMatch[2] };
                            }
                        } else if (subLine.startsWith('#EXTHTTP:')) {
                            const cookieMatch = subLine.match(/"cookie":"([^"]+)"/);
                            if (cookieMatch) {
                                currentChannel.cookie = cookieMatch[1];
                            }
                        } else if (!subLine.startsWith('#')) {
                            if (subLine.includes('.mpd')) {
                                currentChannel.mpd = subLine.split('&xxx=')[0];
                            } else if (subLine.includes('.m3u8')) {
                                currentChannel.m3u8 = subLine;
                            }
                            urlFound = true;
                            i = j;
                        }
                        j++;
                    }
                    if (currentChannel.mpd || currentChannel.m3u8) {
                        channels.push(currentChannel);
                    }
                }
            }
            return channels;
        }

        async function loadAndDisplayChannels(tabName) {
            nStreamPlayerSection.classList.add('hidden');
            nStreamPlayerSection.classList.remove('flex');
            contentDisplay.style.display = 'grid';

            if (tabName === 'n-stream') {
                contentDisplay.style.display = 'none';
                nStreamPlayerSection.classList.remove('hidden');
                nStreamPlayerSection.classList.add('flex');
                return;
            }

            contentDisplay.innerHTML = `<div class="flex items-center justify-center p-4 col-span-full"><div class="loading-spinner mr-3"></div><p class="text-center text-gray-400 font-semibold">चैनल लोड हो रहे हैं...</p></div>`;
            const sourceKey = tabDataUrls[tabName];
            
            try {
                const response = await fetch(`${WORKER_BASE_URL}?source=${sourceKey}`);
                if (!response.ok) {
                    throw new Error(`HTTP त्रुटि! स्थिति: ${response.status}`);
                }
                const data = await response.json().catch(() => null);
                let channelsToDisplay = [];
                
                if (data && data.channels) {
                    channelsToDisplay = data.channels.map(c => ({...c, source: tabName}));
                } else if (data && data.matches) {
                    channelsToDisplay = data.matches.map(match => ({
                        name: `${match.event_name}: ${match.match_name}`,
                        logo: match.src || 'https://placehold.co/200x150/2d3748/a0aec0?text=No+Image',
                        mpd: match.dai_url,
                        m3u8: match.adfree_url,
                        source: tabName
                    }));
                } else {
                    const m3uContent = await response.text();
                    channelsToDisplay = await parseM3U(m3uContent, tabName);
                }
                displayChannels(channelsToDisplay);
            } catch (error) {
                console.error('डेटा लोड करने में त्रुटि:', error);
                contentDisplay.innerHTML = `<p class="text-center text-gray-400 p-4 col-span-full">सामग्री लोड करने में त्रुटि हुई। कृपया बाद में पुनः प्रयास करें।</p>`;
            }
        }
        
        // Event listeners
        tabButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-gray-600', 'hover:bg-gray-500', 'shadow-inner');
                    btn.classList.add('bg-gray-700', 'hover:bg-gray-600', 'shadow-md');
                });
                event.target.classList.add('active', 'bg-gray-600', 'hover:bg-gray-500', 'shadow-inner');
                event.target.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                const tab = event.target.dataset.tab;
                localStorage.setItem('activeTab', tab);
                loadAndDisplayChannels(tab);
            });
        });

        const searchBar = document.querySelector('.search-bar');
        searchBar.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            if (nStreamPlayerSection.classList.contains('flex')) {
                return;
            }
            const filteredChannels = currentLoadedChannels.filter(channel =>
                channel.name.toLowerCase().includes(searchTerm)
            );
            displayChannels(filteredChannels);
        });

        // N Stream specific logic
        streamTypeSelect.addEventListener('change', () => {
            if (streamTypeSelect.value === 'DASH') {
                drmControls.classList.remove('hidden');
                drmControls.classList.add('flex');
            } else {
                drmControls.classList.add('hidden');
                drmControls.classList.remove('flex');
                clearkeyIdInput.value = '';
                clearkeyKeyInput.value = '';
                drmLicenseUrlInput.value = '';
            }
        });

        playNStreamBtn.addEventListener('click', () => {
            const streamUrl = streamUrlInput.value.trim();
            const streamType = streamTypeSelect.value;
            let channelConfig = {
                name: 'N Stream Custom Playback',
                logo: '',
                mpd: null,
                m3u8: null,
                clearkey: null,
                drm: null
            };

            if (!streamUrl) {
                showUserMessage('कृपया स्ट्रीम URL डालें।');
                return;
            }

            if (streamType === 'HLS') {
                channelConfig.m3u8 = streamUrl;
            } else if (streamType === 'DASH') {
                channelConfig.mpd = streamUrl;
                const clearkeyId = clearkeyIdInput.value.trim();
                const clearkeyKey = clearkeyKeyInput.value.trim();
                const drmLicenseUrl = drmLicenseUrlInput.value.trim();
                if (clearkeyId && clearkeyKey) {
                    channelConfig.clearkey = { keyId: clearkeyId, key: clearkeyKey };
                }
                if (drmLicenseUrl) {
                    channelConfig.drm = { type: 'widevine', licenseUrl: drmLicenseUrl };
                }
            }
            
            const urlParams = new URLSearchParams({
                streamUrl: channelConfig.mpd || channelConfig.m3u8,
                name: channelConfig.name,
                source: "n-stream"
            });
            window.open(`${PLAYER_SITE_URL}?${urlParams.toString()}`, '_blank');
        });

        document.addEventListener('DOMContentLoaded', () => {
            const savedTab = localStorage.getItem('activeTab');
            const tabToActivate = savedTab || 'jio-tv';
            const defaultButton = document.querySelector(`.tab-button[data-tab="${tabToActivate}"]`);
            if (defaultButton) {
                defaultButton.click();
            }
        });
    </script>
</body>
</html>
