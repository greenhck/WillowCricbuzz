<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="referrer" content="no-referrer" />
    <!-- SEO Title -->
    <title>Perelive - Watch Live Streams & Channels Online</title>
    <!-- Meta Description -->
    <meta name="description" content="Perelive par dekhein latest live channels aur streams online. Entertainment, news, sports aur more, sab ek hi platform par. Join now!">
    <meta name="keywords" content="live streaming, online TV channels, watch live shows, Perelive, live sports, live news, free streaming, watch online, live entertainment, streaming platform">
    <meta name="google-site-verification" content="JoSAYJv7bUeJMbgQaTPDBpBerWVfYHO60UYENKygDcs" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons (NEWLY ADDED) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Shaka Player for DASH/DRM -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/controls.min.css" crossorigin="anonymous"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.ui.min.js" crossorigin="anonymous"></script>

    <!-- Hls.js for HLS -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <!-- Firebase SDKs for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // Firebase Configuration (Using user-provided config as default)
        const userFirebaseConfig = {
            apiKey: "AIzaSyBz-v2-lbsBtk91ARf75ezB0NpWc7D0Zyg",
            authDomain: "perelive-c0ac2.firebaseapp.com",
            projectId: "perelive-c0ac2",
            storageBucket: "perelive-c0ac2.firebasestorage.app",
            messagingSenderId: "38475348473",
            appId: "1:38475348473:web:c2c8d121216a71944be528",
            measurementId: "G-5HCG31NZX2"
        };

        // IMPORTANT: Using global environment variables if available, otherwise using provided config.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-perelive-app';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for the rest of the script to use
        window.fbApp = app;
        window.fbAuth = auth;
        window.fbDb = db;
        window.fbAppId = appId;
        window.fbServerTimestamp = serverTimestamp;

        // --- Active User Tracking Logic ---
        let globalUserId = null;
        const userActivityCollection = "live_users_presence"; // Dedicated public collection

        // 1. Authentication and Initial Setup
        async function initFirebaseAndAuth() {
            try {
                // Use custom token if provided, otherwise sign in anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }

        // 2. Heartbeat Logic (Update presence every 60 seconds)
        function checkTimeAndHeartbeat() {
            const now = new Date();
            const currentHour = now.getHours(); // 0 (midnight) to 23

            // Check if time is between 12 AM (0) and 6 AM (exclusive, i.e., up to 5:59 AM)
            const isSleepTime = currentHour >= 0 && currentHour < 6;

            if (isSleepTime) {
                console.log("Sleep Time (12 AM - 6 AM): Heartbeat skipped.");
                return;
             }

            if (globalUserId) {
                // Update the user's document with the current timestamp
                const userDocRef = doc(db, userActivityCollection, globalUserId);
                setDoc(userDocRef, {
                    last_seen: serverTimestamp(), // Use server timestamp for accuracy
                    appId: appId
                }, { merge: true }).catch(e => console.error("Heartbeat update failed:", e));
            }
        }

        // 3. Live Counter Listener
        function setupLiveCounter() {
            const userCountDisplay = document.getElementById('user-count-display');
            const q = collection(db, userActivityCollection);

            onSnapshot(q, (snapshot) => {
                let activeUsers = 0;
                // Set the window for activity check to 2 minutes
                const twoMinutesAgo = Date.now() - (2 * 60 * 1000);

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    // Client-side check: Only count users who have updated their presence in the last 2 minutes
                    if (data.last_seen && data.last_seen.toMillis() > twoMinutesAgo) {
                         activeUsers++;
                    }
                });

                userCountDisplay.textContent = activeUsers;

                if (activeUsers < 1) { // Fallback if no docs are present or system is slow
                    userCountDisplay.textContent = '1';
                }
            }, (error) => {
                console.error("Error fetching live user count:", error);
                userCountDisplay.textContent = '...'; // Show error state
            });
        }

        // Handle Auth State Change
        onAuthStateChanged(auth, (user) => {
            if (user) {
                globalUserId = user.uid;
                console.log("Firebase signed in. User ID:", globalUserId);

                // Start initial heartbeat
                checkTimeAndHeartbeat();

                // Set up recurring heartbeat
                setInterval(checkTimeAndHeartbeat, 60000); // 60 seconds (1 minute)

                // Start the counter listener
                setupLiveCounter();
            }
        });

        // Start Auth process on load
        document.addEventListener('DOMContentLoaded', initFirebaseAndAuth);
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom styles for scrollbar in tabs */
        .tabs-container::-webkit-scrollbar {
            height: 0px;
        }
        .tabs-container::-webkit-scrollbar-thumb,
        .tabs-container::-webkit-scrollbar-track {
            background-color: transparent;
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the Recent Stream URL display to be truncated */
        .recent-stream-url {
            display: block;
            max-width: 150px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            line-height: 1; /* Match button height */
        }
        /* Fix for quality selector scrolling over header */
        .shaka-player-container {
            position: relative;
        }
        /* High Z-index for quality selector */
        #quality-selector {
            z-index: 500 !important;
        }
        /* Custom CSS for policy modal animation */
        #policy-modal-content {
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
    <!-- Policy/Info Modal (New Animated UI for ?) -->
    <div id="policy-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[1000] flex items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg shadow-2xl border-t-4 border-yellow-500 transform scale-95 opacity-0 transition-all duration-300" id="policy-modal-content">
            <h3 class="text-2xl font-bold mb-4 text-yellow-400 flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i> महत्वपूर्ण जानकारी (Site Policy)
            </h3>
            <p class="text-gray-300 mb-4 text-sm">
                यह प्लेटफॉर्म केवल शैक्षिक और निजी उपयोग के लिए है। इस पर उपलब्ध किसी भी सामग्री (content) का उपयोग करने की पूरी जिम्मेदारी उपयोगकर्ता की है। 
            </p>
            <p class="text-gray-300 mb-6 text-sm">
                हम किसी भी स्ट्रीमिंग सेवा, चैनल, या सामग्री का समर्थन या होस्ट नहीं करते हैं। सभी स्ट्रीम URL सार्वजनिक रूप से उपलब्ध स्रोतों से संकलित किए गए हैं।
            </p>
            <ul class="list-disc list-inside text-sm text-gray-400 space-y-2 mb-6 bg-gray-700 p-3 rounded-lg">
                <li><strong class="text-white">उपयोगकर्ता जिम्मेदारी:</strong> कृपया अपने क्षेत्र के कॉपीराइट कानूनों का पालन करें।</li>
                <li><strong class="text-white">गोपनीयता:</strong> हम कोई व्यक्तिगत डेटा स्टोर नहीं करते हैं (Firebase User ID केवल लाइव काउंटर के लिए है)।</li>
                <li><strong class="text-white">Telegram:</strong> नए अपडेट्स और लिंक्स के लिए हमारे Telegram चैनल से जुड़ें।</li>
            </ul>
            <button id="policy-modal-close-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 rounded-lg transition duration-200">समझ गया (बंद करें)</button>
        </div>
    </div>

    <!-- Header Section (UPDATED FOR NEW LAYOUT) -->
    <header class="bg-black text-white px-2 sm:px-4 py-3 sticky top-0 z-50 shadow-lg">
        <!-- Top Row: Title (Left), Search (Center), Icons (Right) -->
        <div class="flex items-center justify-between w-full">

            <!-- 1. LEFT: Title and Live Counter -->
            <div class="flex flex-col flex-shrink-0">
                <h1 class="text-xl sm:text-2xl font-bold">PERELIVE</h1>
                <!-- Live Counter -->
                <div id="active-users-counter" class="flex items-center space-x-1 pl-0.5 -mt-1">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                    </span>
                    <span id="user-count-display" class="text-xs font-bold text-red-400">0</span>
                    <span class="text-xs font-semibold text-gray-300">Live</span>
                </div>
            </div>

            <!-- 2. CENTER: Search Bar (Hidden on Mobile, centered on larger screens) -->
            <div class="hidden md:flex flex-grow justify-center mx-4">
                 <input type="text" class="search-bar w-full max-w-sm px-4 py-2 rounded-full border border-gray-700 bg-gray-800 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-300" placeholder="चैनल/मैच खोजें...">
            </div>

            <!-- 3. RIGHT: Icons -->
            <div class="flex items-center space-x-3 flex-shrink-0">
                <!-- Telegram Icon (FAB fa-telegram-plane) -->
                <a href="https://t.me/sportslivelink18" target="_blank" title="Telegram Channel Join Karein" class="text-white hover:text-blue-400 transition duration-200">
                    <i class="fab fa-telegram-plane text-2xl sm:text-3xl"></i>
                </a>
                <!-- Policy Icon (?) (FAS fa-question-circle) -->
                <button id="show-policy-btn" title="Site Policy" class="text-white hover:text-yellow-400 transition duration-200 relative">
                    <i class="fas fa-question-circle text-2xl sm:text-3xl"></i>
                    <!-- Small pulsating indicator/arrow to indicate popup -->
                    <span class="absolute -top-1 -right-1 flex h-3 w-3">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-yellow-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-3 w-3 bg-yellow-500"></span>
                    </span>
                </button>
            </div>
        </div>

        <!-- Secondary Row for Mobile Search (Appears below main bar on mobile) -->
        <div class="md:hidden flex w-full mt-2">
            <input type="text" class="search-bar w-full px-4 py-2 rounded-full border border-gray-700 bg-gray-800 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-300" placeholder="चैनल/मैच खोजें...">
        </div>

        <!-- Bottom Row: Navigation Tabs -->
        <nav class="tabs-container overflow-x-auto flex justify-start items-center space-x-2 pt-3 pb-2 px-1">
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md transform hover:-translate-y-1" data-tab="fancode">Fancode</button>
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md transform hover:-translate-y-1" data-tab="zee-network">Zee Network</button>
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md transform hover:-translate-y-1" data-tab="pirates-tv">Pirates TV</button>
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md transform hover:-translate-y-1" data-tab="jio-tv">Jio TV</button>
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md transform hover:-translate-y-1" data-tab="pere-sports">Pere Sports</button>
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md transform hover:-translate-y-1" data-tab="sony-network">Sony Network</button>
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-inner transform hover:-translate-y-1" data-tab="jiostar">Jiostar</button>
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md transform hover:-translate-y-1" data-tab="voot-tv">Voot TV</button>
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md transform hover:-translate-y-1" data-tab="opplex-tv">Opplex TV</button>
            <button class="tab-button flex-shrink-0 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-full transition-all duration-200 shadow-md transform hover:-translate-y-1" data-tab="n-stream">N Stream</button>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-2 sm:p-4 w-full mx-auto">
        <!-- Video Player Container -->
        <!-- Note: Removed 'hidden' and added 'flex' as default for continuous display, even if reset -->
        <div id="video-player-container" class="bg-gray-800 rounded-lg shadow-xl my-4 flex flex-col space-y-4">
            <div data-shaka-player-container class="shaka-player-container w-full h-full max-h-screen aspect-video relative flex items-center justify-center">
                <!-- Quality Selector moved to top-right corner with high Z-index fix -->
                <select id="quality-selector" class="absolute top-4 right-4 z-500 bg-gray-700 text-white py-1 px-3 rounded-md text-xs font-semibold hidden cursor-pointer shadow-lg hover:bg-gray-600 transition duration-150">
                    <option value="auto">स्वचालित</option>
                </select>
                <video autoplay data-shaka-player id="shaka-video-player" class="w-full h-full object-contain"></video>
            </div>
            <video id="hls-video-player" class="w-full h-full max-h-screen object-contain" controls></video>
        </div>

        <!-- N Stream Section (Manual Stream Input) -->
        <div id="n-stream-player-section" class="bg-gray-800 p-5 rounded-lg shadow-xl mt-4 hidden flex-col space-y-4">
            <h2 class="text-2xl font-semibold text-center">N Stream (मैन्युअल स्ट्रीम)</h2>
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <label for="stream-type-select" class="text-sm">स्ट्रीम प्रकार:</label>
                <select id="stream-type-select" class="w-full sm:w-auto px-3 py-2 rounded-md bg-gray-700 border border-gray-600 text-gray-100 focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <option value="HLS">HLS (M3U8/Generic URL)</option>
                    <option value="DASH">DASH (MPD)</option>
                </select>
            </div>
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                <label for="stream-url-input" class="text-sm">स्ट्रीम URL:</label>
                <input type="text" id="stream-url-input" class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="यहां M3U8, MPD, या लाइव प्रॉक्सी लिंक डालें">
            </div>
            <!-- Cookies Input field was previously removed on user request, retaining removal -->
            
            <div id="drm-controls" class="drm-inputs flex-col space-y-2 pl-4 border-l-2 border-gray-600 hidden">
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label for="clearkey-id-input" class="text-sm">Clear Key ID:</label>
                    <input type="text" id="clearkey-id-input" class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Clear Key ID (हेक्स, डैश के बिना)">
                </div>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label for="clearkey-key-input" class="text-sm">Clear Key:</label>
                    <input type="text" id="clearkey-key-input" class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Clear Key (हेक्स, डैश के बिना)">
                </div>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label for="drm-license-url-input" class="text-sm">DRM लाइसेंस URL:</label>
                    <input type="text" id="drm-license-url-input" class="w-full px-3 py-2 rounded-md bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="DRM लाइसेंस URL (यदि आवश्यक हो)">
                </div>
            </div>
            <div class="flex justify-end">
                <button id="play-n-stream-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition-all duration-200">चलाएं</button>
            </div>
            <!-- Recent Streams Container -->
            <div id="recent-streams-container" class="mt-6 border-t border-gray-700 pt-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-300">हाल ही की स्ट्रीम्स (Recent Streams)</h3>
                    <!-- NEW: Clear All Button -->
                    <button id="clear-recent-streams-btn" class="text-xs text-red-400 hover:text-red-300 font-medium py-1 px-3 rounded-full border border-red-500 hover:border-red-400 transition duration-150 shadow-sm hidden" title="सभी हालिया स्ट्रीम्स हटाएँ">सभी साफ़ करें</button>
                </div>
                <div id="recent-streams-list" class="flex flex-wrap gap-3">
                    <p id="no-recent-streams" class="text-sm text-gray-500">कोई हालिया स्ट्रीम नहीं।</p>
                </div>
            </div>
        </div>

        <div id="content-display" class="content-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 sm:gap-4 md:gap-5 mt-4">
            <!-- Channel cards will be inserted here -->
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-black text-gray-400 text-center text-sm py-4 mt-auto">
        <p>&copy; 2025 PEREGRINE LIVE. सभी अधिकार सुरक्षित।</p>
    </footer>

    <!-- JavaScript -->
    <script>
        const contentDisplay = document.getElementById('content-display');
        const tabButtons = document.querySelectorAll('.tab-button');
        const videoPlayerContainer = document.getElementById('video-player-container');
        const shakaVideoContainer = document.getElementById('shaka-video-player').parentNode;
        const shakaVideoElement = document.getElementById('shaka-video-player');
        const hlsVideoElement = document.getElementById('hls-video-player');
        const qualitySelector = document.getElementById('quality-selector');

        // Policy Modal Elements
        const showPolicyBtn = document.getElementById('show-policy-btn');
        const policyModal = document.getElementById('policy-modal');
        const policyModalContent = document.getElementById('policy-modal-content');
        const policyModalCloseBtn = document.getElementById('policy-modal-close-btn');

        let shakaPlayerInstance = null;
        let hlsPlayer = null;
        let currentLoadedChannels = [];
        let currentTab = '';

        // GLOBAL FIX: Variable to store the dynamic network filter function for Shaka Player
        let shakaNetworkingFilter = null;
        
        // --- NEW: Stability and Crash Prevention Variables ---
        let shakaErrorCount = 0;
        let lastShakaErrorTime = 0;
        // Allows 5 errors within 10 seconds before aggressively stopping the streaming engine
        const MAX_ERRORS_PER_WINDOW = 5; 
        const ERROR_WINDOW_MS = 10000;

        // N Stream elements
        const nStreamPlayerSection = document.getElementById('n-stream-player-section');
        const streamTypeSelect = document.getElementById('stream-type-select');
        const streamUrlInput = document.getElementById('stream-url-input');
        const drmControls = document.getElementById('drm-controls');
        const clearkeyIdInput = document.getElementById('clearkey-id-input');
        const clearkeyKeyInput = document.getElementById('clearkey-key-input');
        const drmLicenseUrlInput = document.getElementById('drm-license-url-input');
        const playNStreamBtn = document.getElementById('play-n-stream-btn');
        const recentStreamsList = document.getElementById('recent-streams-list');
        const clearRecentStreamsBtn = document.getElementById('clear-recent-streams-btn');

        // GitHub Raw JSON URLs (UPDATED Voot TV PATH and ADDED Opplex TV)
        const tabDataUrls = {
            'zee-network': 'https://raw.githubusercontent.com/greenhck/batball/main/zee.json',
            'fancode': 'https://raw.githubusercontent.com/Odfinity/live-events/refs/heads/main/fancode/data.json',
            'pirates-tv': 'https://raw.githubusercontent.com/FunctionError/PiratesTv/main/combined_playlist.m3u',
            'jio-tv': 'https://raw.githubusercontent.com/rocket12-18/dineshbhai/refs/heads/main/jd.m3u',
            'pere-sports': 'https://raw.githubusercontent.com/abusaeeidx/CricHd-playlists-Auto-Update-permanent/refs/heads/main/ALL.m3u',
            'sony-network': 'https://raw.githubusercontent.com/rocket12-18/dineshbhai/refs/heads/main/sports-pere.m3u',
            'jiostar': 'https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u',
            'voot-tv': 'vootTvP.json',
            'opplex-tv': 'opplexPere.json',
            'n-stream': null,
        };

        // --- Policy Modal Logic ---
        function togglePolicyModal(show) {
            if (show) {
                policyModal.classList.remove('hidden');
                // Use setTimeout to trigger transition after display block
                setTimeout(() => {
                    policyModal.classList.add('opacity-100');
                    policyModalContent.classList.add('scale-100', 'opacity-100');
                    policyModalContent.classList.remove('scale-95', 'opacity-0');
                }, 10);
            } else {
                policyModal.classList.remove('opacity-100');
                policyModalContent.classList.remove('scale-100', 'opacity-100');
                policyModalContent.classList.add('scale-95', 'opacity-0');
                // Use setTimeout to hide modal after transition
                setTimeout(() => {
                    policyModal.classList.add('hidden');
                }, 300); // Match transition duration
            }
        }

        // Event listeners for Policy Modal
        if(showPolicyBtn) {
            showPolicyBtn.addEventListener('click', () => togglePolicyModal(true));
        }
        if(policyModalCloseBtn) {
            policyModalCloseBtn.addEventListener('click', () => togglePolicyModal(false));
        }
        // Close on outside click
        if(policyModal) {
            policyModal.addEventListener('click', (e) => {
                if (e.target === policyModal) {
                    togglePolicyModal(false);
                }
            });
        }
        // --- End Policy Modal Logic ---


        // --- URL Management (New Sharable Logic) ---
        function updateQueryParam(key, value) {
            const url = new URL(window.location);
            if (value) {
                url.searchParams.set(key, value);
            } else {
                url.searchParams.delete(key);
            }
            window.history.pushState({}, '', url);
        }

        function updateChannelShareableUrl(channelName) {
            // Only update if a channel name is provided and we are not in N-Stream tab
            if (channelName && currentTab !== 'n-stream') {
                updateQueryParam('tab', currentTab);
                updateQueryParam('channel', encodeURIComponent(channelName));
                updateQueryParam('n', null); // Remove N-Stream param if present
            }
        }

        function updateNStreamShareableUrl(channelConfig) {
            updateQueryParam('tab', 'n-stream');
            updateQueryParam('channel', null); // Remove channel param if present

            let nParamValue = channelConfig.mpd || channelConfig.m3u8 || '';
            let params = [];

            if (channelConfig.clearkey && channelConfig.clearkey.keyId && channelConfig.clearkey.key) {
                params.push(`drmScheme=clearkey&drmLicense=${channelConfig.clearkey.keyId}:${channelConfig.clearkey.key}`);
            } else if (channelConfig.drm && channelConfig.drm.licenseUrl) {
                params.push(`drmScheme=widevine&drmLicense=${encodeURIComponent(channelConfig.drm.licenseUrl)}`);
            }
            // Cookie handling removed from shareable URL for N-Stream as per user request.

            if (params.length > 0) {
                nParamValue += `|${params.join('&')}`;
            }

            updateQueryParam('n', encodeURIComponent(nParamValue));
        }

        // --- Player Core Functions (UPDATED FOR STABILITY) ---

        // NEW: Aggressive but passive player stop to prevent browser crash
        function passiveStopPlayer(title, message) {
            // Log the event instead of popping up an error box
            console.error(`[CRASH PREVENTION ACTIVE] ${title}: ${message}`);

            // 1. Unload/Destroy Players
            if (shakaPlayerInstance) {
                shakaPlayerInstance.unload().catch(e => console.warn("Shaka Player unload failed during passive stop:", e));
                // FIX: Remove custom network filter on stop
                if (shakaNetworkingFilter) {
                    shakaPlayerInstance.getNetworkingEngine().unregisterRequestFilter(shakaNetworkingFilter);
                    shakaNetworkingFilter = null;
                    console.log("Custom Shaka network filter removed during passive stop.");
                }
            }
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            
            // 2. Clean video elements (keeping the container visible)
            shakaVideoElement.pause();
            shakaVideoElement.removeAttribute('src');
            shakaVideoElement.load(); // Reset to initial state
            hlsVideoElement.pause();
            hlsVideoElement.removeAttribute('src');
            hlsVideoElement.load(); // Reset to initial state
            
            qualitySelector.innerHTML = '<option value="auto">स्वचालित</option>';
            qualitySelector.classList.add('hidden');
            
            // 3. Reset crash prevention state for the next attempt
            shakaErrorCount = 0;
            lastShakaErrorTime = 0;
        }
        
        // Shaka Player error handler with Rate Limiting
        function handleShakaError(event) {
            const error = event.detail;
            console.warn('[Shaka Error]', error);

            const now = Date.now();
            
            // If the last error was outside the window, reset the counter
            if (now - lastShakaErrorTime > ERROR_WINDOW_MS) {
                shakaErrorCount = 0;
            }

            shakaErrorCount++;
            lastShakaErrorTime = now;

            // Check for crash prevention limit (if too many errors too quickly)
            if (shakaErrorCount > MAX_ERRORS_PER_WINDOW) {
                console.error("CRASH PREVENTION ACTIVATED: Too many errors occurred too quickly. Stopping player passively.");
                passiveStopPlayer("क्रैश रोकथाम सक्रिय", "अत्यधिक त्रुटियों के कारण प्लेबैक को निष्क्रिय रूप से रोका जा रहा है।");
                return; // Stop processing this error
            }

            // Optional logging for specific problematic errors
            if (error.code === 4012) { 
                console.log(`Specific error 4012 (Media Runtime Error) detected. Relying on internal recovery or rate limiter. Error count: ${shakaErrorCount}`);
            } else if (error.code === 1001) { // Networking error (e.g. 403, 404)
                console.log(`Networking error ${error.data?.[1] || 'Unknown'}. Shaka is retrying (Attempt: ${shakaErrorCount}).`);
            }
        }
        
        // HLS.js error handler with Passive Stop for fatal errors
        function handleHlsError(event, data) {
            console.error('HLS.js Error:', data);
            if (data.fatal) {
                passiveStopPlayer("HLS क्रैश रोकथाम सक्रिय", "HLS स्ट्रीम में गंभीर त्रुटि हुई। निष्क्रिय रूप से रोका जा रहा है।");
            }
        }

        // Initialize Shaka Player UI once it's loaded (Mandatory for Shaka UI to work)
        document.addEventListener('shaka-ui-loaded', () => {
            console.log('Shaka UI Loaded, initializing Shaka Player instance...');
            shaka.polyfill.installAll();
            const ui = shakaVideoElement['ui'];
            const controls = ui.getControls();
            shakaPlayerInstance = controls.getPlayer();
            
            // FIX: Use the new rate-limited error handler
            shakaPlayerInstance.addEventListener('error', handleShakaError);

            // Configuration adjusted for stability and to prevent page unresponsiveness.
            shakaPlayerInstance.configure({
                streaming: {
                    lowLatencyMode: true, // Keep low latency, but compensate with larger buffer
                    // FIX: Increase buffering goal to give more stability to high-load streams like JioStar
                    bufferingGoal: 45, // 45 seconds (was 15)
                    rebufferingGoal: 2,
                    bufferBehind: 45,  // Match buffer behind to buffering goal
                    retryParameters: {
                        // FIX: Increase backoff factor and base delay to prevent network flooding on unstable streams
                        timeout: 15000, // Increased timeout to 15s
                        maxAttempts: 7, // Allow a few more attempts
                        baseDelay: 2000, // Wait 2 seconds before first retry (was 1s)
                        backoffFactor: 3.0 // Triple the delay each time (was 2.0)
                    },
                    segmentRequestTimeout: 15000, // Increased timeout (was 10000)
                    segmentPrefetchLimit: 2,
                    useNativeHlsOnSafari: true
                },
                manifest: {
                    retryParameters: {
                        timeout: 10000,
                        maxAttempts: 5
                    }
                }
            });
            console.log('Shaka Player instance initialized via UI with stability-focused config.');
        });
        
        // This function now only cleans up without triggering a hard error stop
        function resetPlayers() {
            shakaVideoContainer.style.display = 'none';
            hlsVideoElement.style.display = 'none';

            // Reset error counter on successful player reset (in preparation for a new load)
            shakaErrorCount = 0;
            lastShakaErrorTime = 0; 
            
            if (shakaPlayerInstance) {
                shakaPlayerInstance.unload().catch(e => console.warn("Shaka Player unload failed:", e));
                // Reset DRM config only, keeping the fast streaming configuration
                shakaPlayerInstance.configure({
                    drm: {}
                });

                // FIX: Remove custom network filter
                if (shakaNetworkingFilter) {
                    shakaPlayerInstance.getNetworkingEngine().unregisterRequestFilter(shakaNetworkingFilter);
                    shakaNetworkingFilter = null;
                    console.log("Custom Shaka network filter removed.");
                }
            }
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }

            // Ensure video elements are clean
            shakaVideoElement.pause();
            shakaVideoElement.removeAttribute('src');
            hlsVideoElement.pause();
            hlsVideoElement.removeAttribute('src');

            qualitySelector.innerHTML = '<option value="auto">स्वचालित</option>';
            qualitySelector.classList.add('hidden');
        }

        // Removed the old closePlayer, passiveStopPlayer handles the crash prevention exit.
        // For general UI switching, we don't need a hard close, just a reset.

        // Disable Auto Fullscreen/Autoplay Tweaks (Passive Playback Logic)
        function handlePlaybackLogic(video, isShaka, channelName = null) {
            let hasUserInteracted = false;
            const enableSoundOnInteraction = () => {
                if (!hasUserInteracted) {
                    video.muted = false;
                    hasUserInteracted = true;
                    video.volume = 0.8;
                    console.log('Sound enabled after user interaction (User Clicked)');
                }
            };
            // Listen for any user interaction on the whole document
            ['click', 'touchstart', 'keydown'].forEach(event => {
                document.addEventListener(event, enableSoundOnInteraction, { once: true });
            });

            // Set initial muted state for attempted autoplay
            video.muted = true;

            const attemptAutoplay = () => {
                video.play().then(() => {
                    console.log('Autoplay successful (muted)!');
                    // Update sharable URL on successful playback for regular channels
                    if (!isShaka && channelName && currentTab !== 'n-stream') {
                        updateChannelShareableUrl(channelName);
                    }
                }).catch(e => {
                    console.warn('Autoplay failed, user interaction required.', e);
                });
            };

            // Attempt to autoplay immediately
            if (video.readyState >= 3) {
                attemptAutoplay();
            } else {
                video.addEventListener('canplay', attemptAutoplay, { once: true });
            }

            // Only for Shaka Player: When the player is fully loaded and ready
            if (isShaka) {
                if (shakaPlayerInstance) {
                    shakaPlayerInstance.addEventListener('loaded', () => {
                        // Update sharable URL on successful playback for regular channels
                        if (channelName && currentTab !== 'n-stream') {
                            updateChannelShareableUrl(channelName);
                        }
                    }, {once: true});
                }
            }
        }

        // playChannel function updated to handle custom User-Agent and Cookies from M3U parsing
        async function playChannel(channel) {
            console.log('Playing channel:', channel.name);
            // FIX: Do not hide/show videoPlayerContainer, assume it's always visible
            // videoPlayerContainer.classList.remove('hidden');
            // videoPlayerContainer.classList.add('flex');
            nStreamPlayerSection.classList.add('hidden'); // Hide N-Stream section
            nStreamPlayerSection.classList.remove('flex');

            resetPlayers(); // Clears previous player and network filter

            try {
                // --- Common Spoofing Headers for Shaka/HLS ---
                const fixedSpoofHeaders = {
                    'Referer': 'https://www.jiotv.com/',
                    // Default User-Agent for JioTV/similar links
                    'User-Agent': "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6"
                };

                // Override fixed headers with custom channel headers (extracted from M3U)
                const requestHeaders = { ...fixedSpoofHeaders };

                if (channel.customUserAgent) {
                    // Use custom User-Agent if provided in M3U
                    requestHeaders['User-Agent'] = channel.customUserAgent;
                }

                if (channel.customCookies) {
                    // Use custom Cookies if provided in M3U
                    requestHeaders['Cookie'] = channel.customCookies;
                }

                // Priority 1: HLS (m3u8 or generic non-MPD link)
                if (channel.m3u8) {
                    shakaVideoContainer.style.display = 'none';
                    hlsVideoElement.style.display = 'block';

                    if (Hls.isSupported()) {
                        hlsPlayer = new Hls({
                            liveSyncDuration: 3,
                            liveMaxLatencyDuration: 10,
                            // Use xhrSetup to include headers for HLS.js
                            xhrSetup: function(xhr, url) {
                                for (const header in requestHeaders) {
                                    xhr.setRequestHeader(header, requestHeaders[header]);
                                }
                                console.log(`[HLS Filter] Request URL: ${url}, Final Headers:`, requestHeaders);
                            }
                        });
                        hlsPlayer.loadSource(channel.m3u8);
                        hlsPlayer.attachMedia(hlsVideoElement);
                        hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
                            console.log('HLS manifest parsed (hls.js)!');
                            handlePlaybackLogic(hlsVideoElement, false, channel.name);
                        });
                        // FIX: Use new HLS error handler
                        hlsPlayer.on(Hls.Events.ERROR, handleHlsError);
                        
                        console.log('HLS M3U8 URL loading (hls.js):', channel.m3u8);
                    } else if (hlsVideoElement.canPlayType('application/vnd.apple.mpegurl')) {
                        hlsVideoElement.src = channel.m3u8;
                        hlsVideoElement.addEventListener('loadedmetadata', () => handlePlaybackLogic(hlsVideoElement, false, channel.name));
                        console.log('Using browser\'s native HLS support.');
                    } else {
                        console.error('आपका ब्राउज़र HLS वीडियो चलाने का समर्थन नहीं करता है।');
                        // FIX: Passive stop instead of closing player or showing modal
                        passiveStopPlayer("HLS संगतता त्रुटि", "आपका ब्राउज़र HLS वीडियो चलाने का समर्थन नहीं करता है।");
                    }
                }
                // Priority 2: DASH (mpd)
                else if (channel.mpd) {
                    shakaVideoContainer.style.display = 'block';
                    hlsVideoElement.style.display = 'none';

                    if (!shakaPlayerInstance) {
                        console.error('Shaka Player instance is not ready!');
                        passiveStopPlayer("Shaka Player त्रुटि", "Shaka Player इंस्टेंस तैयार नहीं है।");
                        return;
                    }

                    // --- Build DRM Configuration ONLY (Streaming config is set globally for faster performance) ---
                    const shakaConfig = {
                        drm: {} // Default empty DRM
                    };

                    // DRM Configuration
                    if (channel.clearkey && channel.clearkey.keyId && channel.clearkey.key) {
                        // Note: Keys are expected to be clean (no dashes) from parseM3U now
                        const keyId = channel.clearkey.keyId.replace(/-/g, '').toLowerCase();
                        const key = channel.clearkey.key.replace(/-/g, '').toLowerCase();
                        shakaConfig.drm.clearKeys = { [keyId]: key };
                        console.log('ClearKey DRM configured (Shaka Player).');
                    } else if (channel.drm && channel.drm.licenseUrl) {
                        const servers = {};
                        // Only supporting Widevine by default if type is not specified
                        servers['com.widevine.alpha'] = channel.drm.licenseUrl;
                        shakaConfig.drm.servers = servers;
                        shakaConfig.drm.advanced = {};
                        console.log(`DRM configured (Shaka Player) License URL: ${channel.drm.licenseUrl}`);
                    } else {
                        console.log('No ClearKey or DRM configured for this DASH channel.');
                    }

                    shakaPlayerInstance.configure(shakaConfig); // Apply ONLY DRM configuration

                    // --- Use registerRequestFilter for dynamic headers (Correct Method) ---

                    // Define the filter function to set the dynamic headers on every request
                    shakaNetworkingFilter = (type, request) => {
                        // 1. Apply all headers (Referer, User-Agent, Cookie) from the dynamic requestHeaders object
                        Object.assign(request.headers, requestHeaders);

                        // 2. Append the full cookie string to the URL query parameters
                        const customCookieString = requestHeaders['Cookie'];

                        if (customCookieString &&
                            (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
                              type === shaka.net.NetworkingEngine.RequestType.SEGMENT)) {

                            // Check if the URL already contains the cookie token (to avoid double appending)
                            if (!request.uris[0].includes('__hdnea__=')) {
                                 const separator = request.uris[0].includes('?') ? '&' : '?';
                                // The customCookieString should contain the full token string (e.g., __hdnea__=st=...)
                                // The token is appended directly as the value of the 'Cookie' header is the signed string itself.
                                request.uris[0] += separator + customCookieString;
                             }
                        }

                        // CRITICAL DEBUG LOG: Check final URL and headers
                        console.log(`[Shaka Filter] Request Type: ${type}, Final URL: ${request.uris[0]}, Final Headers:`, request.headers);
                    };

                    // Register the filter
                    shakaPlayerInstance.getNetworkingEngine().registerRequestFilter(shakaNetworkingFilter);
                    console.log('Dynamic network filter registered with User-Agent, Cookie Header, and URL signing.');

                    console.log('DASH MPD URL loading (Shaka Player):', channel.mpd);
                    await shakaPlayerInstance.load(channel.mpd);
                    console.log('Video loaded (Shaka Player)!');
                    handlePlaybackLogic(shakaVideoElement, true, channel.name);
                    setupShakaQualitySelector(); // Setup quality selector after load
                } else {
                    console.error('इस चैनल के लिए कोई मान्य स्ट्रीम URL (MPD या M3U8/Generic) नहीं मिला।');
                    passiveStopPlayer("URL त्रुटि", "इस चैनल के लिए कोई मान्य स्ट्रीम URL (MPD या M3U8/Generic) नहीं मिला।");
                }
            } catch (e) {
                // Shaka Player error objects are caught here, which then trigger the rate limiter
                handleShakaError({ detail: e });
            }
        }

        // --- Channel Mapping Function for Voot TV (and similar JSON structures) ---
        function mapVootTvChannels(data) {
            if (!Array.isArray(data)) {
                console.error("Voot TV data is not an array:", data);
                return [];
            }
            return data.map(item => ({
                name: item.channel_name || item.id,
                logo: item.logo || 'https://placehold.co/200x150/2d3748/a0aec0?text=Voot+TV',
                // Check if the URL is an MPD (DASH) or M3U8 (HLS)
                m3u8: (item.url && item.url.includes('.m3u8') && !item.url.includes('.mpd')) ? item.url : null,
                mpd: (item.url && item.url.includes('.mpd')) ? item.url : null,
                // Assuming generic proxy links are M3U8/Generic HLS or similar, so mapping the whole URL to M3U8 if no MPD.
                m3u8: item.url && !item.url.includes('.mpd') ? item.url : null,
                clearkey: null,
                drm: null,
                customUserAgent: null,
                customCookies: null
            }));
        }

        // --- NEW: Channel Mapping Function for Opplex TV (nested JSON structure) ---
        function mapOpplexChannels(data) {
            let allChannels = [];
            if (typeof data !== 'object' || data === null) {
                console.error("Opplex TV data is not a valid object:", data);
                return [];
            }

            // Iterate over each category key (e.g., "PAKISTAN | ENTERTAINMENT")
            for (const category in data) {
                if (Array.isArray(data[category])) {
                    data[category].forEach(item => {
                        // The URLs are generic PHP links which should be tested with HLS/Generic player
                        const isMpd = item.url && item.url.includes('.mpd');

                        allChannels.push({
                            // UPDATED: Only use the original name, remove the category/country prefix
                            name: item.name.replace(/•●★--- Welcome ----★●•/g, 'Welcome'),
                            logo: item.logo || 'https://placehold.co/200x150/2d3748/a0aec0?text=Opplex+TV',
                            mpd: isMpd ? item.url : null,
                            m3u8: !isMpd && item.url ? item.url : null, // Treat generic links as m3u8/generic
                            clearkey: null,
                            drm: null,
                            customUserAgent: null,
                            customCookies: null
                        });
                    });
                }
            }
            return allChannels;
        }

        // --- Channel Loading Functions ---
        async function parseM3U(m3uContent) {
            const lines = m3uContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const channels = [];
            let currentChannel = {};

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                if (line.startsWith('#EXTINF:')) {
                    currentChannel = {
                        name: 'Unknown Channel',
                        logo: '',
                        mpd: null,
                        m3u8: null,
                        clearkey: null,
                        drm: null,
                        customUserAgent: null, // New field for extracted User-Agent
                        customCookies: null    // New field for extracted Cookie
                    };

                    const nameMatch = line.match(/,(.+)$/);
                    currentChannel.name = nameMatch ? nameMatch[1].trim() : 'Unknown Channel';
                    const logoMatch = line.match(/tvg-logo="?([^"]*)"?/i);
                    currentChannel.logo = logoMatch && logoMatch[1] ? logoMatch[1] : '';

                    let j = i + 1;
                    let urlFound = false;

                    // Parse metadata lines until a URL or next EXTINF is hit
                    while (j < lines.length) {
                        const subLine = lines[j];

                        if (subLine.startsWith('#EXTINF:')) {
                            // Hit the next channel entry before finding a URL, stop and break
                            break;
                        } else if (subLine.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                            // ClearKey handling
                            const clearkeyMatch = subLine.match(/license_key=([^:]+):([a-f0-9]+)/);
                            if (clearkeyMatch) {
                                currentChannel.clearkey = {
                                    keyId: clearkeyMatch[1],
                                    key: clearkeyMatch[2]
                                };
                            }
                        } else if (subLine.startsWith('#EXTVLCOPT:http-user-agent=')) {
                            // Custom User-Agent handling
                            const uaMatch = subLine.match(/http-user-agent=(.+)/);
                            if (uaMatch) {
                                // Capture the UA string (e.g., plaYtv/7.1.3 ...)
                                currentChannel.customUserAgent = uaMatch[1].trim();
                            }
                        } else if (subLine.startsWith('#EXTHTTP:')) {
                            // Custom Cookie handling
                            const cookieMatch = subLine.match(/{"cookie":"([^"]+)"}/);
                            if (cookieMatch) {
                                // Capture the raw cookie string (__hdnea__=...)
                                currentChannel.customCookies = cookieMatch[1];
                            }
                        } else if (!subLine.startsWith('#') && subLine.startsWith('http')) {
                            // Found the URL line
                            if (subLine.includes('.mpd')) {
                                // For JioStar, use the full URL including query params
                                currentChannel.mpd = subLine;
                            } else {
                                // If it's a URL but not MPD, assume it's HLS (m3u8).
                                currentChannel.m3u8 = subLine;
                            }
                            urlFound = true;
                            i = j; // Update main loop index to skip metadata/url lines
                            break; // Exit inner while loop
                        }
                        j++;
                    }

                    if (urlFound) {
                        channels.push(currentChannel);
                    }
                    // If URL not found, currentChannel is discarded, and the loop continues from the original 'i' or adjusted 'i'
                }
            }
            return channels;
        }

        function displayChannels(channels) {
            currentLoadedChannels = channels;
            contentDisplay.innerHTML = '';
            // FIX: Only display the content grid if we have channels to show
            if (channels.length === 0) {
                contentDisplay.innerHTML = `<p class="text-center text-gray-400 p-4">कोई चैनल/मैच नहीं मिला।</p>`;
                contentDisplay.classList.remove('hidden');
                return;
            }
            contentDisplay.classList.remove('hidden');
            channels.forEach(channel => {
                const channelCard = document.createElement('div');
                channelCard.classList.add('channel-card', 'bg-gray-800', 'rounded-lg', 'overflow-hidden', 'shadow-lg', 'cursor-pointer', 'transform', 'transition-transform', 'duration-200', 'hover:-translate-y-1', 'hover:shadow-2xl');
                channelCard.innerHTML = `
                    <img src="${channel.logo || 'https://placehold.co/200x150/2d3748/a0aec0?text=No+Image'}" onerror="this.onerror=null;this.src='https://placehold.co/200x150/2d3748/a0aec0?text=No+Image';" alt="${channel.name}" class="w-full h-32 sm:h-40 object-cover">
                    <h3 class="p-2 sm:p-3 text-sm sm:text-base font-semibold text-center truncate">${channel.name}</h3>
                `;
                channelCard.addEventListener('click', () => {
                    playChannel(channel);
                    // Update URL immediately on user click, actual stream shareable update happens on success
                    updateChannelShareableUrl(channel.name);
                });
                contentDisplay.appendChild(channelCard);
            });
        }

        async function loadAndDisplayChannels(tabName, channelToPlay = null) {
            currentTab = tabName;

            // Handle UI switching: Show player container, hide content display initially
            videoPlayerContainer.classList.remove('hidden');
            contentDisplay.classList.add('hidden');

            if (tabName === 'n-stream') {
                contentDisplay.classList.add('hidden');
                nStreamPlayerSection.classList.remove('hidden');
                nStreamPlayerSection.classList.add('flex');
                loadRecentStreams();
                return;
            }

            // Regular tab load: Hide N-Stream section and show content display loading
            nStreamPlayerSection.classList.add('hidden');
            nStreamPlayerSection.classList.remove('flex');
            contentDisplay.classList.remove('hidden'); 
            
            // Update active tab button style
            tabButtons.forEach(btn => {
                // Clear all active/color classes
                btn.classList.remove('active', 'bg-gray-600', 'hover:bg-gray-500', 'shadow-inner');
                // Restore default color classes (Voot/Opplex colors removed from HTML, so this is safe)
                btn.classList.add('bg-gray-700', 'hover:bg-gray-600', 'shadow-md');

                // Apply activation style for the current tab
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active', 'bg-gray-600', 'hover:bg-gray-500', 'shadow-inner');
                    btn.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'shadow-md');
                }
            });


            // Update loading message with spinner
            contentDisplay.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <div class="loading-spinner mr-3"></div>
                    <p class="text-center text-gray-400 font-semibold">Loading channels...</p>
                </div>
            `;
            const dataUrl = tabDataUrls[tabName];
            let channelsToDisplay = [];

            try {
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP त्रुटि! स्थिति: ${response.status}। सुनिश्चित करें कि JSON फाइल (${dataUrl}) रूट फ़ोल्डर में मौजूद है और पहुंच योग्य है।`);
                }

                if (tabName === 'zee-network') {
                    const data = await response.json();
                    if (data && data.channels) {
                        channelsToDisplay = data.channels;
                    } else {
                        throw new Error('Zee Network के लिए अमान्य डेटा संरचना।');
                    }
                } else if (tabName === 'fancode') {
                    const data = await response.json();
                    if (data && data.matches) {
                        channelsToDisplay = data.matches.map(match => ({
                            name: `${match.event_name}: ${match.match_name}`,
                            logo: match.src || 'https://placehold.co/200x150/2d3748/a0aec0?text=No+Image',
                            mpd: match.dai_url,
                            m3u8: match.adfree_url,
                            clearkey: null,
                            drm: null,
                            customUserAgent: null,
                            customCookies: null
                        }));
                    } else {
                        throw new Error('FanCode के लिए अमान्य डेटा संरचना।');
                    }
                } else if (tabName === 'voot-tv') {
                    // Voot TV JSON mapping
                    const data = await response.json();
                    channelsToDisplay = mapVootTvChannels(data);
                } else if (tabName === 'opplex-tv') {
                    // Opplex TV JSON mapping
                    const data = await response.json();
                    channelsToDisplay = mapOpplexChannels(data);
                } else {
                    const m3uContent = await response.text();
                    channelsToDisplay = await parseM3U(m3uContent);
                }

                displayChannels(channelsToDisplay);

                // Auto-play shared channel
                if (channelToPlay) {
                    const channel = channelsToDisplay.find(c => c.name === channelToPlay);
                    if (channel) {
                        console.log(`Auto-playing shared channel: ${channelToPlay}`);
                        // Delay play slightly to ensure player UI is ready and DOM is updated
                        setTimeout(() => playChannel(channel), 100);
                    } else {
                        console.warn(`Shared channel "${channelToPlay}" not found in tab "${tabName}".`);
                    }
                }
            } catch (error) {
                console.error('डेटा लोड करने में त्रुटि:', error);
                contentDisplay.innerHTML = `<p class="text-center text-red-400 p-4 font-semibold">सामग्री लोड करने में त्रुटि हुई: ${error.message}</p>`;
            }
        }

        // --- Quality Selector Logic ---
        function setupShakaQualitySelector() {
            if (!shakaPlayerInstance) return;

            const tracks = shakaPlayerInstance.getVariantTracks();
            qualitySelector.innerHTML = '<option value="auto">स्वचालित</option>';

            // Filter out audio-only tracks and sort by bandwidth (bitrate)
            const videoTracks = tracks.filter(t => t.type === 'variant' && t.height > 0).sort((a, b) => b.bandwidth - a.bandwidth);

            videoTracks.forEach(track => {
                const option = document.createElement('option');
                option.value = track.id;
                // Displaying resolution and bitrate
                option.textContent = `${track.height}p (${Math.round(track.bandwidth / 1000)} Kbps)`;
                qualitySelector.appendChild(option);
            });

            if (videoTracks.length > 1) {
                qualitySelector.classList.remove('hidden');
            } else {
                qualitySelector.classList.add('hidden');
            }

            // Set initial selection to the active track or auto
            const activeTrack = shakaPlayerInstance.getVariantTracks().find(t => t.active);
            qualitySelector.value = activeTrack ? activeTrack.id : 'auto';
        }

        qualitySelector.addEventListener('change', (e) => {
            if (!shakaPlayerInstance) return;
            const trackId = e.target.value;

            if (trackId === 'auto') {
                shakaPlayerInstance.configure({ abr: { enabled: true } });
            } else {
                shakaPlayerInstance.configure({ abr: { enabled: false } });
                const track = shakaPlayerInstance.getVariantTracks().find(t => t.id == trackId);
                if (track) {
                    shakaPlayerInstance.selectVariantTrack(track, true);
                }
            }
        });

        // --- Recent Streams Logic ---
        function getRecentStreams() {
            try {
                const streams = JSON.parse(localStorage.getItem('recentNStreams') || '[]');
                return Array.isArray(streams) ? streams : [];
            } catch (e) {
                console.error("Error parsing recent streams from localStorage:", e);
                return [];
            }
        }

        function clearRecentStreams() {
            try {
                localStorage.removeItem('recentNStreams');
                console.log('Recent streams cleared.');
                loadRecentStreams(); // Refresh the display
            } catch (e) {
                console.error("Error clearing recent streams:", e);
            }
        }

        function saveRecentStream(channelConfig) {
            const maxStreams = 5;
            let streams = getRecentStreams();

            // Create a unique key for the stream based on its primary URL
            const url = channelConfig.mpd || channelConfig.m3u8;
            if (!url) return;

            // Remove sensitive DRM keys and keep only required fields for history
            const simpleConfig = {
                mpd: channelConfig.mpd,
                m3u8: channelConfig.m3u8,
                clearkey: channelConfig.clearkey ? { keyId: channelConfig.clearkey.keyId, key: channelConfig.clearkey.key } : null,
                drm: channelConfig.drm ? { licenseUrl: channelConfig.drm.licenseUrl } : null
            };

            // Remove existing stream with the same URL to put the new one at the front
            streams = streams.filter(s => (s.mpd || s.m3u8) !== url);

            // Add new stream to the front
            streams.unshift(simpleConfig);

            // Keep only the maxStreams number
            streams = streams.slice(0, maxStreams);

            try {
                localStorage.setItem('recentNStreams', JSON.stringify(streams));
                loadRecentStreams(); // Refresh the list
            } catch (e) {
                console.error("Error saving recent streams to localStorage:", e);
            }
        }

        function loadRecentStreams() {
            const streams = getRecentStreams();
            recentStreamsList.innerHTML = '';

            if (streams.length === 0) {
                recentStreamsList.innerHTML = `<p id="no-recent-streams" class="text-sm text-gray-500">कोई हालिया स्ट्रीम नहीं।</p>`;
                clearRecentStreamsBtn.classList.add('hidden'); // Hide button
                return;
            }

            clearRecentStreamsBtn.classList.remove('hidden'); // Show button

            streams.forEach(stream => {
                const streamUrl = stream.mpd || stream.m3u8 || 'N/A';
                const type = stream.mpd ? 'DASH' : 'HLS';
                const keyId = stream.clearkey ? stream.clearkey.keyId : '';
                const key = stream.clearkey ? stream.clearkey.key : '';
                const licenseUrl = stream.drm ? stream.drm.licenseUrl : '';

                const button = document.createElement('button');
                button.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-white', 'py-2', 'px-3', 'rounded-lg', 'text-sm', 'transition-all', 'duration-200', 'shadow-md', 'flex', 'flex-col', 'items-start');

                button.innerHTML = `
                    <span class="font-semibold text-blue-300">${type} Stream</span>
                    <span class="text-xs text-gray-400 recent-stream-url" title="${streamUrl}">${streamUrl}</span>
                `;

                button.addEventListener('click', () => {
                    // Pre-fill N-Stream inputs
                    streamUrlInput.value = streamUrl;
                    streamTypeSelect.value = type;
                    clearkeyIdInput.value = keyId;
                    clearkeyKeyInput.value = key;
                    drmLicenseUrlInput.value = licenseUrl;

                    // Trigger change event to show/hide DRM controls
                    const changeEvent = new Event('change');
                    streamTypeSelect.dispatchEvent(changeEvent);

                    // Play the stream directly
                    playNStreamBtn.click();
                });

                recentStreamsList.appendChild(button);
            });
        }
        // --- Event Listeners and Initialization ---

        // Tab button event listeners
        tabButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const tab = event.target.dataset.tab;

                // Update URL for tab selection, remove channel/n
                updateQueryParam('tab', tab);
                updateQueryParam('channel', null);
                updateQueryParam('n', null);
                localStorage.setItem('activeTab', tab);

                loadAndDisplayChannels(tab);
            });
        });

        // Search bar logic
        const searchBar = document.querySelector('.search-bar');
        searchBar.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();

            // Find the correct search bar element (handles mobile/desktop difference)
            const currentSearchBar = document.querySelector('input.search-bar:focus') || document.querySelector('.search-bar');
            const actualSearchTerm = currentSearchBar.value.toLowerCase();

            if (nStreamPlayerSection.classList.contains('flex')) {
                return;
            }
            const filteredChannels = currentLoadedChannels.filter(channel =>
                channel.name.toLowerCase().includes(actualSearchTerm)
            );
            displayChannels(filteredChannels);
        });

        // N Stream specific logic
        streamTypeSelect.addEventListener('change', () => {
            if (streamTypeSelect.value === 'DASH') {
                drmControls.classList.remove('hidden');
                drmControls.classList.add('flex');
            } else {
                drmControls.classList.add('hidden');
                drmControls.classList.remove('flex');
                clearkeyIdInput.value = '';
                clearkeyKeyInput.value = '';
                drmLicenseUrlInput.value = '';
            }
        });

        // Clear recent streams button listener
        clearRecentStreamsBtn.addEventListener('click', clearRecentStreams);

        playNStreamBtn.addEventListener('click', () => {
            const streamUrl = streamUrlInput.value.trim();
            const streamType = streamTypeSelect.value;

            let channelConfig = {
                name: 'N Stream Custom Playback',
                logo: '',
                mpd: null,
                m3u8: null,
                clearkey: null,
                drm: null
                // Note: customUserAgent and customCookies are NOT supported for manual N Stream as per previous user request.
            };

            if (!streamUrl) {
                console.error('कृपया स्ट्रीम URL डालें।');
                // Passive log instead of modal
                console.log("URL आवश्यक: कृपया 'स्ट्रीम URL' इनपुट फ़ील्ड में एक मान्य पता डालें।");
                return;
            }

            if (streamType === 'HLS') {
                channelConfig.m3u8 = streamUrl;
            } else if (streamType === 'DASH') {
                channelConfig.mpd = streamUrl;
                const clearkeyId = clearkeyIdInput.value.trim();
                const clearkeyKey = clearkeyKeyInput.value.trim();
                const drmLicenseUrl = drmLicenseUrlInput.value.trim();

                if (clearkeyId && clearkeyKey) {
                    channelConfig.clearkey = {
                        keyId: clearkeyId,
                        key: clearkeyKey
                    };
                }
                if (drmLicenseUrl) {
                    channelConfig.drm = {
                        type: 'widevine',
                        licenseUrl: drmLicenseUrl
                    };
                }
            }

            // Play the channel. No custom headers needed now for N Stream.
            playChannel(channelConfig);

            // Save to recent streams after successful attempt
            saveRecentStream(channelConfig);

            // Update sharable URL for N-Stream
            updateNStreamShareableUrl(channelConfig);
        });

        // --- Initialization on DOMContentLoaded (Handles Shared URLs) ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const nParam = urlParams.get('n');
            const sharedTab = urlParams.get('tab');
            const sharedChannel = urlParams.get('channel');

            let tabToActivate = sharedTab || localStorage.getItem('activeTab') || 'pere-sports';

            // Case 1: Shared N-Stream URL
            if (nParam) {
                tabToActivate = 'n-stream';
                const nValue = decodeURIComponent(nParam);

                let streamUrl = nValue;
                let clearkeyId = '';
                let clearkeyKey = '';
                let drmLicenseUrl = '';
                let streamType = 'HLS';

                // Split URL from parameters
                const parts = nValue.split('|');
                streamUrl = parts[0];

                if (parts.length > 1) {
                    const params = new URLSearchParams(parts[1]);

                    // DRM/ClearKey Parsing
                    const drmScheme = params.get('drmScheme');
                    if (drmScheme === 'clearkey') {
                        const license = params.get('drmLicense');
                        if (license) {
                            const [kid, key] = license.split(':');
                            clearkeyId = kid;
                            clearkeyKey = key;
                            streamType = 'DASH';
                        }
                    } else if (drmScheme === 'widevine') {
                        drmLicenseUrl = params.get('drmLicense');
                        streamType = 'DASH';
                    }
                } else if (streamUrl.includes('.mpd')) {
                    streamType = 'DASH';
                }

                const nStreamTabButton = document.querySelector('.tab-button[data-tab="n-stream"]');
                if (nStreamTabButton) {
                    // Manually set tab and update URL, then proceed with N-Stream logic
                    currentTab = 'n-stream';
                    updateQueryParam('tab', 'n-stream');
                    loadAndDisplayChannels('n-stream'); // Load N-Stream section

                    // Populate inputs and play after a short delay
                    setTimeout(() => {
                        streamUrlInput.value = streamUrl;
                        streamTypeSelect.value = streamType;

                        const changeEvent = new Event('change');
                        streamTypeSelect.dispatchEvent(changeEvent);

                        clearkeyIdInput.value = clearkeyId;
                        clearkeyKeyInput.value = clearkeyKey;
                        drmLicenseUrlInput.value = drmLicenseUrl;

                        playNStreamBtn.click(); // Auto-play the stream
                    }, 100);
                }
            }
            // Case 2: Shared Regular Channel URL
            else if (sharedTab && sharedChannel) {
                const tabButton = document.querySelector(`.tab-button[data-tab="${sharedTab}"]`);
                if (tabButton) {
                    // Directly load the tab and pass the channel name for auto-play
                    // We don't need to 'click' the button, just call the loader
                    loadAndDisplayChannels(sharedTab, decodeURIComponent(sharedChannel));
                }
            }
            // Case 3: Default/Saved Tab Load
            else {
                const defaultButton = document.querySelector(`.tab-button[data-tab="${tabToActivate}"]`);
                if (defaultButton) {
                    // Directly load the tab
                    loadAndDisplayChannels(tabToActivate);
                } else {
                    // Fallback to Jio TV if default/saved tab not found
                    loadAndDisplayChannels('jio-tv');
                }
            }
        });
    </script>
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "68a40879f6b244629841d4be7aec5e0f"}'></script><!-- End Cloudflare Web Analytics -->
</body>
</html>
