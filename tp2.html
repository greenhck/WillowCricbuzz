<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="referrer" content="no-referrer" />
    
    <!-- SEO Meta Tags -->
    <title>PERELIVE: Live TV, Sports & News Streams | Watch Online</title>
    <meta name="description" content="Watch live TV channels, sports (Cricket, Football) and entertainment streams online in India without interruption. Experience the best streaming platform.">
    <meta name="keywords" content="live streaming, online TV channels, watch live shows, Perelive, live sports, live news, free streaming, watch online, live entertainment, streaming platform, HLS, DASH, DRM">
    <meta name="google-site-verification" content="JoSAYJv7bUeJMbgQaTPDBpBerWVfYHO60UYENKygDcs" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    <!-- Shaka Player for DASH/DRM -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/controls.min.css" crossorigin="anonymous"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.ui.min.js" crossorigin="anonymous"></script>

    <!-- Hls.js for HLS -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* BASE STYLES & FONT */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* HEADER: Slightly darker background for depth and a blue bottom border */
        header {
            background-color: #1f2937; /* Gray-800 */
            border-bottom: 2px solid #3b82f6; /* Blue-500 accent */
        }
        
        /* SLEEK TABS: Removed rounded corners, shadows, and transform effects */
        .tab-button {
            transition: all 0.2s ease-in-out;
            border-radius: 0; /* Make tabs sharp */
            color: #d1d5db; /* Default text color (gray-300) */
            font-weight: 600;
            padding: 12px 16px;
            background-color: transparent !important; /* Ensure transparent background */
            border-bottom: 3px solid transparent;
        }

        /* ACTIVE TAB: Blue indicator line for professional look */
        .tab-button.active {
            color: #ffffff; /* White text when active */
            border-bottom-color: #3b82f6; /* Blue-500 bottom border */
            font-weight: 700;
        }
        
        /* HOVER TAB */
        .tab-button:not(.active):hover {
            color: #ffffff; /* White text on hover */
            background-color: #374151; /* Gray-700 subtle hover background */
        }

        /* CHANNEL CARD: Enhanced Hover Effect */
        .channel-card {
            transition: all 0.3s ease-in-out;
            border: 2px solid transparent; /* Default transparent border */
        }

        .channel-card:hover {
            /* Transform is subtle and adds a glow effect using shadow and border */
            transform: scale(1.02);
            border-color: #3b82f6; /* Blue-500 border on hover */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); /* Blue glow */
        }

        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .recent-stream-url {
            display: block;
            max-width: 150px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            line-height: 1; 
        }
        
        .shaka-player-container {
            position: relative;
        }
        
        /* Quality selector Z-index fix */
        #quality-selector {
            z-index: 500 !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
    <!-- Message Box Modal (Now fully English) -->
    <div id="message-box-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[1000] flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg shadow-2xl border-t-4 border-red-500">
            <h3 id="message-box-title" class="text-xl font-bold mb-3 text-red-400">STREAMING ERROR</h3>
            <p id="message-box-content" class="text-gray-300 mb-5 text-sm"></p>
            <button id="message-box-close-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg transition duration-200">OK (Close Player)</button>
        </div>
    </div>

    <!-- Header Section -->
    <header class="text-white px-2 sm:px-4 py-3 sticky top-0 z-50 shadow-lg">
        <div class="flex flex-col sm:flex-row items-center justify-between">
            <h1 class="text-2xl sm:text-3xl font-extrabold flex-shrink-0 tracking-wider text-blue-400 mb-2 sm:mb-0">
                PEREGRINE LIVE
            </h1>
            <div class="flex-grow w-full sm:w-auto flex justify-end">
                <input type="text" class="search-bar w-full max-w-xs px-4 py-2 rounded-lg border border-gray-600 bg-gray-700 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow duration-300" placeholder="Search Channels...">
            </div>
        </div>
        <!-- Tab Navigation (Sleek, Border-based) -->
        <nav class="tabs-container overflow-x-auto flex justify-start items-center space-x-0 sm:space-x-1 mt-3 -mb-1">
            <button class="tab-button" data-tab="fancode">Fancode</button>
            <button class="tab-button" data-tab="zee-network">Zee Network</button>
            <button class="tab-button" data-tab="pirates-tv">Pirates TV</button>
            <button class="tab-button" data-tab="jio-tv">Jio TV</button>
            <button class="tab-button" data-tab="pere-sports">Pere Sports</button>
            <button class="tab-button" data-tab="sony-network">Sony Network</button>
            <button class="tab-button" data-tab="jiostar">Jiostar</button>
            <button class="tab-button" data-tab="voot-tv">Voot TV</button>
            <button class="tab-button" data-tab="opplex-tv">Opplex TV</button>
            <button class="tab-button" data-tab="n-stream">N Stream (Manual)</button>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-2 sm:p-4 w-full mx-auto max-w-7xl">
        <!-- Video Player Container -->
        <div id="video-player-container" class="bg-gray-800 rounded-xl shadow-2xl my-4 hidden flex-col space-y-4">
            <div data-shaka-player-container class="shaka-player-container w-full h-full max-h-screen aspect-video relative flex items-center justify-center">
                <select id="quality-selector" class="absolute top-4 right-4 z-[500] bg-gray-700 text-white py-1 px-3 rounded-md text-xs font-semibold hidden cursor-pointer shadow-lg hover:bg-gray-600 transition duration-150">
                    <option value="auto">Auto</option>
                </select>
                <video autoplay data-shaka-player id="shaka-video-player" class="w-full h-full object-contain"></video>
            </div>
            <video id="hls-video-player" class="w-full h-full max-h-screen object-contain" controls></video>
        </div>

        <!-- N Stream Section (Manual Stream Input) -->
        <div id="n-stream-player-section" class="bg-gray-800 p-5 rounded-xl shadow-2xl mt-4 hidden flex-col space-y-4 max-w-3xl mx-auto">
            <h2 class="text-2xl font-semibold text-center text-blue-400">N Stream (Manual Stream Playback)</h2>
            <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <label for="stream-type-select" class="text-sm font-medium">Stream Type:</label>
                <select id="stream-type-select" class="w-full sm:w-auto px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="HLS">HLS (M3U8/Generic URL)</option>
                    <option value="DASH">DASH (MPD)</option>
                </select>
            </div>
            <div class="flex flex-col sm:flex-row items-center space-y-3 sm:space-y-0 sm:space-x-4">
                <label for="stream-url-input" class="text-sm font-medium">Stream URL:</label>
                <input type="text" id="stream-url-input" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter M3U8, MPD, or live proxy link here">
            </div>

            <div id="drm-controls" class="drm-inputs flex-col space-y-3 p-4 border-l-4 border-blue-500 rounded-lg bg-gray-700/50 hidden">
                <h3 class="font-semibold text-lg text-blue-300">DRM/ClearKey Settings (For DASH)</h3>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label for="clearkey-id-input" class="text-sm font-medium w-32">Clear Key ID:</label>
                    <input type="text" id="clearkey-id-input" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Clear Key ID (Hex, no dashes)">
                </div>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label for="clearkey-key-input" class="text-sm font-medium w-32">Clear Key:</label>
                    <input type="text" id="clearkey-key-input" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Clear Key (Hex, no dashes)">
                </div>
                <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                    <label for="drm-license-url-input" class="text-sm font-medium w-32">DRM License URL:</label>
                    <input type="text" id="drm-license-url-input" class="w-full px-4 py-2 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="DRM License URL (if required)">
                </div>
            </div>
            <div class="flex justify-end">
                <button id="play-n-stream-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-full shadow-lg transition-all duration-200 transform hover:scale-105">Play Stream</button>
            </div>
            <!-- Recent Streams Container -->
            <div id="recent-streams-container" class="mt-6 border-t border-gray-700 pt-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-300">Recent Streams</h3>
                    <button id="clear-recent-streams-btn" class="text-xs text-red-400 hover:text-red-300 font-medium py-1 px-3 rounded-full border border-red-500 hover:border-red-400 transition duration-150 shadow-sm hidden" title="Remove all recent streams">Clear All</button>
                </div>
                <div id="recent-streams-list" class="flex flex-wrap gap-3">
                    <p id="no-recent-streams" class="text-sm text-gray-500">No recent streams.</p>
                </div>
            </div>
        </div>

        <div id="content-display" class="content-grid grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-5 mt-4">
            <!-- Channel cards will be inserted here -->
        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-800 text-gray-400 text-center text-sm py-4 mt-auto border-t border-gray-700">
        <p>&copy; 2025 PEREGRINE LIVE. All Rights Reserved.</p>
    </footer>

    <!-- JavaScript with Enhanced Error Handling and Stability -->
    <script>
        const contentDisplay = document.getElementById('content-display');
        const tabButtons = document.querySelectorAll('.tab-button');
        const videoPlayerContainer = document.getElementById('video-player-container');
        const shakaVideoContainer = document.getElementById('shaka-video-player').parentNode;
        const shakaVideoElement = document.getElementById('shaka-video-player');
        const hlsVideoElement = document.getElementById('hls-video-player');
        const qualitySelector = document.getElementById('quality-selector');
        
        // Message Box Elements
        const messageBoxModal = document.getElementById('message-box-modal');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxContent = document.getElementById('message-box-content');
        const messageBoxCloseBtn = document.getElementById('message-box-close-btn');

        let shakaPlayerInstance = null;
        let hlsPlayer = null;
        let currentLoadedChannels = [];
        let currentTab = '';
        
        let shakaNetworkingFilter = null;

        // N Stream elements
        const nStreamPlayerSection = document.getElementById('n-stream-player-section');
        const streamTypeSelect = document.getElementById('stream-type-select');
        const streamUrlInput = document.getElementById('stream-url-input');
        const drmControls = document.getElementById('drm-controls');
        const clearkeyIdInput = document.getElementById('clearkey-id-input');
        const clearkeyKeyInput = document.getElementById('clearkey-key-input');
        const drmLicenseUrlInput = document.getElementById('drm-license-url-input');
        const playNStreamBtn = document.getElementById('play-n-stream-btn');
        const recentStreamsList = document.getElementById('recent-streams-list');
        const clearRecentStreamsBtn = document.getElementById('clear-recent-streams-btn');


        // GitHub Raw JSON URLs 
        const tabDataUrls = {
            'zee-network': 'https://raw.githubusercontent.com/greenhck/batball/main/zee.json',
            'fancode': 'https://raw.githubusercontent.com/Odfinity/live-events/refs/heads/main/fancode/data.json',
            'pirates-tv': 'https://raw.githubusercontent.com/FunctionError/PiratesTv/main/combined_playlist.m3u',
            'jio-tv': 'https://raw.githubusercontent.com/rocket12-18/dineshbhai/refs/heads/main/jd.m3u',
            'pere-sports': 'https://raw.githubusercontent.com/abusaeeidx/CricHd-playlists-Auto-Update-permanent/refs/heads/main/ALL.m3u',
            'sony-network': 'https://raw.githubusercontent.com/rocket12-18/dineshbhai/refs/heads/main/sports-pere.m3u',
            'jiostar': 'https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jstar.m3u',
            'voot-tv': 'vootTvP.json', 
            'opplex-tv': 'opplexPere.json',
            'n-stream': null,
        };
        
        // --- Custom Message Box for Errors ---
        function showMessageBox(title, content) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            messageBoxModal.classList.remove('hidden');
        }

        messageBoxCloseBtn.addEventListener('click', () => {
            messageBoxModal.classList.add('hidden');
            closePlayer(); 
        });


        // --- URL Management (Sharable Logic) ---
        function updateQueryParam(key, value) {
            const url = new URL(window.location);
            if (value) {
                url.searchParams.set(key, value);
            } else {
                url.searchParams.delete(key);
            }
            window.history.pushState({}, '', url);
        }

        function updateChannelShareableUrl(channelName) {
            if (channelName && currentTab !== 'n-stream') {
                updateQueryParam('tab', currentTab);
                updateQueryParam('channel', encodeURIComponent(channelName));
                updateQueryParam('n', null); 
            }
        }

        function updateNStreamShareableUrl(channelConfig) {
            updateQueryParam('tab', 'n-stream');
            updateQueryParam('channel', null); 

            let nParamValue = channelConfig.mpd || channelConfig.m3u8 || '';
            let params = [];

            if (channelConfig.clearkey && channelConfig.clearkey.keyId && channelConfig.clearkey.key) {
                params.push(`drmScheme=clearkey&drmLicense=${channelConfig.clearkey.keyId}:${channelConfig.clearkey.key}`);
            } else if (channelConfig.drm && channelConfig.drm.licenseUrl) {
                params.push(`drmScheme=widevine&drmLicense=${encodeURIComponent(channelConfig.drm.licenseUrl)}`);
            }

            if (params.length > 0) {
                nParamValue += `|${params.join('&')}`;
            }

            updateQueryParam('n', encodeURIComponent(nParamValue));
        }

        // --- Player Core Functions ---
        document.addEventListener('shaka-ui-loaded', () => {
            console.log('Shaka UI Loaded, initializing Shaka Player instance...');
            shaka.polyfill.installAll();
            const ui = shakaVideoElement['ui'];
            const controls = ui.getControls();
            shakaPlayerInstance = controls.getPlayer();
            shakaPlayerInstance.addEventListener('error', onErrorEvent);
            
            // **ENHANCED STABILITY CONFIGURATION**
            shakaPlayerInstance.configure({
                streaming: { 
                    // Aggressive, low-latency config for live streams
                    lowLatencyMode: true, 
                    bufferingGoal: 45, 
                    rebufferingGoal: 2,
                    bufferBehind: 45,  
                    retryParameters: {
                        // Increased retry attempts and faster timeouts
                        timeout: 5000, // Reduced request timeout
                        maxAttempts: 10, // Increased max attempts to recover from transient errors
                        baseDelay: 500, // Faster initial delay
                        backoffFactor: 2.0 
                    },
                    segmentRequestTimeout: 5000, // CRITICAL: Reduced to 5 seconds to prevent long hangs
                    segmentPrefetchLimit: 2,
                    useNativeHlsOnSafari: true
                },
                manifest: {
                    retryParameters: {
                        timeout: 10000,
                        maxAttempts: 5
                    }
                }
            });
            console.log('Shaka Player instance initialized via UI with stability-focused config.');
        });

        function onErrorEvent(event) {
            onError(event.detail);
        }

        function onError(error) {
            console.error('Shaka Player Error:', error);
            
            const message = error.message || "An unknown streaming error occurred.";
            let userMessage = "";
            let title = "Streaming Playback Error";
            let debugInfo = `Shaka Error Code: ${error.code}. See console for details.`;

            if (error.code) {
                switch (error.code) {
                    case 1001: // Networking error
                        const status = error.data && error.data[1] ? error.data[1] : 'Unknown';
                        if (status === 403) {
                            userMessage = "HTTP Error 403 (Forbidden): The stream token/cookie is invalid or expired. This stream link is restricted.";
                            title = "AUTHENTICATION ERROR (403)";
                        } else if (status === 404) {
                            userMessage = "HTTP Error 404 (Not Found): The stream URL could not be reached. The channel might not be live or the link has changed.";
                            title = "CHANNEL NOT FOUND (404)";
                        } else if (status === 401) {
                            userMessage = "HTTP Error 401 (Unauthorized): Authentication is required but failed.";
                            title = "UNAUTHORIZED (401)";
                        } else if (status === 0) {
                            userMessage = "Network/CORS Error: The browser blocked the request. This may be due to CORS restrictions or a lost internet connection.";
                            title = "NETWORK BLOCK/CORS ERROR";
                        } else {
                            userMessage = `Network Data Error (HTTP ${status}): Failed to fetch streaming data. Please check your network connection.`;
                        }
                        break;

                    case 4001: // Media error
                        userMessage = "Media Decoding Error: The video/audio data is corrupt, or your browser cannot decode this specific stream format (MIME Type).";
                        title = "MEDIA DECODING FAILURE";
                        break;

                    case 6001: // DRM error
                        userMessage = "DRM License Error: Failed to acquire the content decryption key from the license server. Check if your DRM URL/Keys are correct.";
                        title = "DRM LICENSING FAILED";
                        break;
                        
                    case 7000: // Manifest parsing error
                        userMessage = "Manifest Parsing Error: The MPD/M3U8 file is invalid, empty, or incorrectly structured. The stream cannot be initialized.";
                        title = "MANIFEST LOAD ERROR";
                        break;

                    default:
                         userMessage = `A critical playback error occurred. Shaka Code ${error.code}: Please refresh or try a different stream.`;
                         title = "CRITICAL STREAM ERROR";
                         break;
                }
            } else {
                userMessage = message;
            }
            
            // Add Debug Info to User Message in a friendly way
            userMessage += `\n\nDebug Reference: Shaka Code ${error.code}.`;

            showMessageBox(title, userMessage);
            closePlayer();
        }

        // Hls.js Error Handling
        function handleHlsError(event, data) {
            console.error('HLS.js Error:', data);
            let title = "HLS Streaming Error";
            let userMessage = "A general error occurred while loading the HLS stream. See console for details.";

            if (data.fatal) {
                switch(data.type) {
                case Hls.ErrorTypes.NETWORK_ERROR:
                    if (data.details.includes('403')) {
                        title = "HLS AUTHENTICATION ERROR (403)";
                        userMessage = "HTTP Error 403 (Forbidden): The stream token/cookie is invalid or expired. This stream link is restricted.";
                    } else if (data.details.includes('404')) {
                        title = "HLS CHANNEL NOT FOUND (404)";
                        userMessage = "HTTP Error 404 (Not Found): The stream URL could not be reached. The channel might not be live or the link has changed.";
                    } else {
                        title = "HLS NETWORK ERROR";
                        userMessage = `The HLS stream could not be loaded from the network (Details: ${data.details}). The URL might be invalid or restricted.`;
                    }
                    break;
                case Hls.ErrorTypes.MEDIA_ERROR:
                    title = "HLS MEDIA DECODING FAILURE";
                    userMessage = "Media decoding error. The stream data is corrupt or incompatible with the browser.";
                    break;
                default:
                    title = "HLS FATAL ERROR";
                    userMessage = `A fatal HLS error occurred (Type: ${data.type}). Player will close for stability.`;
                    break;
                }
                
                userMessage += `\n\nDebug Reference: HLS Fatal Type ${data.type}.`;
                showMessageBox(title, userMessage);
                closePlayer();
            } else {
                 console.warn(`HLS Warning: ${data.details}`);
            }
        }


        function resetPlayers() {
            shakaVideoContainer.style.display = 'none';
            hlsVideoElement.style.display = 'none';

            if (shakaPlayerInstance) {
                shakaPlayerInstance.unload().catch(e => console.warn("Shaka Player unload failed:", e));
                shakaPlayerInstance.configure({ 
                    drm: {}
                });

                if (shakaNetworkingFilter) {
                    shakaPlayerInstance.getNetworkingEngine().unregisterRequestFilter(shakaNetworkingFilter);
                    shakaNetworkingFilter = null;
                    console.log("Custom Shaka network filter removed.");
                }
            }
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }

            shakaVideoElement.pause();
            shakaVideoElement.removeAttribute('src');
            hlsVideoElement.pause();
            hlsVideoElement.removeAttribute('src');

            qualitySelector.innerHTML = '<option value="auto">Auto</option>';
            qualitySelector.classList.add('hidden');
        }

        function closePlayer() {
            videoPlayerContainer.classList.add('hidden');
            videoPlayerContainer.classList.remove('flex');
            resetPlayers();
            contentDisplay.style.display = 'grid';
            updateQueryParam('channel', null); 
            updateQueryParam('n', null); 
        }

        function handlePlaybackLogic(video, isShaka, channelName = null) {
            let hasUserInteracted = false;
            const enableSoundOnInteraction = () => {
                if (!hasUserInteracted) {
                    video.muted = false;
                    hasUserInteracted = true;
                    video.volume = 0.8;
                    console.log('Sound enabled after user interaction (User Clicked)');
                }
            };

            ['click', 'touchstart', 'keydown'].forEach(event => {
                document.addEventListener(event, enableSoundOnInteraction, { once: true });
            });

            video.muted = true;

            const attemptAutoplay = () => {
                video.play().then(() => {
                    console.log('Autoplay successful (muted)!');
                    if (!isShaka && channelName && currentTab !== 'n-stream') {
                        updateChannelShareableUrl(channelName);
                    }
                }).catch(e => {
                    console.warn('Autoplay failed, user interaction required.', e);
                });
            };

            if (video.readyState >= 3) {
                attemptAutoplay();
            } else {
                video.addEventListener('canplay', attemptAutoplay, { once: true });
            }

            if (isShaka && shakaPlayerInstance) {
                shakaPlayerInstance.addEventListener('loaded', () => {
                    if (channelName && currentTab !== 'n-stream') {
                        updateChannelShareableUrl(channelName);
                    }
                }, {once: true});
            }
        }

        async function playChannel(channel) { 
            console.log('Attempting to play channel:', channel.name);
            videoPlayerContainer.classList.remove('hidden');
            videoPlayerContainer.classList.add('flex');
            nStreamPlayerSection.classList.add('hidden'); 
            nStreamPlayerSection.classList.remove('flex');

            resetPlayers(); 

            try {
                // Common spoofing headers
                const fixedSpoofHeaders = {
                    'Referer': 'https://www.jiotv.com/',
                    'User-Agent': "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6"
                };

                const requestHeaders = { ...fixedSpoofHeaders };

                if (channel.customUserAgent) {
                    requestHeaders['User-Agent'] = channel.customUserAgent;
                }

                if (channel.customCookies) {
                    requestHeaders['Cookie'] = channel.customCookies; 
                }
                
                if (channel.m3u8) {
                    shakaVideoContainer.style.display = 'none';
                    hlsVideoElement.style.display = 'block';

                    if (Hls.isSupported()) {
                        hlsPlayer = new Hls({
                            // Enhanced stability settings for HLS
                            liveSyncDuration: 3,
                            liveMaxLatencyDuration: 10,
                            maxBufferLength: 45, // Max buffer length in seconds
                            maxMaxBufferLength: 60,
                            // XHR setup for headers
                            xhrSetup: function(xhr, url) {
                                for (const header in requestHeaders) {
                                    xhr.setRequestHeader(header, requestHeaders[header]);
                                }
                                console.log(`[HLS Filter] Request URL: ${url}, Final Headers:`, requestHeaders);
                            }
                        });
                        hlsPlayer.loadSource(channel.m3u8);
                        hlsPlayer.attachMedia(hlsVideoElement);
                        hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
                            console.log('HLS manifest parsed (hls.js)!');
                            handlePlaybackLogic(hlsVideoElement, false, channel.name);
                        });
                        // Use the consolidated Hls.js error handler
                        hlsPlayer.on(Hls.Events.ERROR, handleHlsError);

                        console.log('HLS M3U8 URL loading (hls.js):', channel.m3u8);
                    } else if (hlsVideoElement.canPlayType('application/vnd.apple.mpegurl')) {
                        hlsVideoElement.src = channel.m3u8;
                        hlsVideoElement.addEventListener('loadedmetadata', () => handlePlaybackLogic(hlsVideoElement, false, channel.name));
                        console.log('Using browser\'s native HLS support.');
                    } else {
                        console.error('Browser does not support HLS video playback.');
                        showMessageBox("Browser Compatibility Error", "Your browser does not support HLS video playback.");
                        closePlayer();
                    }
                }
                else if (channel.mpd) {
                    shakaVideoContainer.style.display = 'block';
                    hlsVideoElement.style.display = 'none';

                    if (!shakaPlayerInstance) {
                        console.error('Shaka Player instance is not ready!');
                        closePlayer();
                        return;
                    }

                    const shakaConfig = {
                        drm: {}
                    };

                    // DRM/ClearKey configuration logic remains the same
                    if (channel.clearkey && channel.clearkey.keyId && channel.clearkey.key) {
                        const keyId = channel.clearkey.keyId.replace(/-/g, '').toLowerCase();
                        const key = channel.clearkey.key.replace(/-/g, '').toLowerCase();
                        shakaConfig.drm.clearKeys = { [keyId]: key };
                        console.log('ClearKey DRM configured (Shaka Player).');
                    } else if (channel.drm && channel.drm.licenseUrl) {
                        const servers = {};
                        servers['com.widevine.alpha'] = channel.drm.licenseUrl;
                        shakaConfig.drm.servers = servers;
                        shakaConfig.drm.advanced = {};
                        console.log(`DRM configured (Shaka Player) License URL: ${channel.drm.licenseUrl}`);
                    } 

                    shakaPlayerInstance.configure(shakaConfig); 

                    // Networking Filter for Headers and URL signing
                    shakaNetworkingFilter = (type, request) => {
                        Object.assign(request.headers, requestHeaders);
                        
                        const customCookieString = requestHeaders['Cookie'];

                        if (customCookieString &&
                            (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || 
                             type === shaka.net.NetworkingEngine.RequestType.SEGMENT)) {
                            
                            if (!request.uris[0].includes('__hdnea__=')) { 
                                const separator = request.uris[0].includes('?') ? '&' : '?';
                                // Note: We prepend a generic header for spoofing, this is not actual cookie usage
                                request.uris[0] += separator + customCookieString; 
                            }
                        }
                        console.log(`[Shaka Filter] Request Type: ${type}, Final URL: ${request.uris[0]}, Final Headers:`, request.headers);
                    };

                    shakaPlayerInstance.getNetworkingEngine().registerRequestFilter(shakaNetworkingFilter);
                    console.log('Dynamic network filter registered with User-Agent, Cookie Header, and URL signing.');


                    console.log('DASH MPD URL loading (Shaka Player):', channel.mpd);
                    await shakaPlayerInstance.load(channel.mpd);
                    console.log('Video loaded (Shaka Player)!');
                    handlePlaybackLogic(shakaVideoElement, true, channel.name);
                    setupShakaQualitySelector(); 

                } else {
                    console.error('No valid stream URL (MPD or M3U8/Generic) found for this channel.');
                    showMessageBox("URL Error", "No valid stream URL (MPD or M3U8/Generic) found for this channel.");
                    closePlayer();
                }

            } catch (e) {
                onError(e);
            }
        }

        function mapVootTvChannels(data) {
            if (!Array.isArray(data)) {
                console.error("Voot TV data is not an array:", data);
                return [];
            }
            return data.map(item => ({
                name: item.channel_name || item.id,
                logo: item.logo || 'https://placehold.co/200x150/2d3748/a0aec0?text=Voot+TV',
                m3u8: (item.url && item.url.includes('.m3u8') && !item.url.includes('.mpd')) ? item.url : null, 
                mpd: (item.url && item.url.includes('.mpd')) ? item.url : null,
                m3u8: item.url && !item.url.includes('.mpd') ? item.url : null, 
                clearkey: null,
                drm: null,
                customUserAgent: null,
                customCookies: null
            }));
        }

        function mapOpplexChannels(data) {
            let allChannels = [];
            if (typeof data !== 'object' || data === null) {
                console.error("Opplex TV data is not a valid object:", data);
                return [];
            }

            for (const category in data) {
                if (Array.isArray(data[category])) {
                    data[category].forEach(item => {
                        const isMpd = item.url && item.url.includes('.mpd');

                        allChannels.push({
                            // Only use the original name, remove the category/country prefix
                            name: item.name.replace(/•●★--- Welcome ----★●•/g, 'Welcome'), 
                            logo: item.logo || 'https://placehold.co/200x150/2d3748/a0aec0?text=Opplex+TV',
                            mpd: isMpd ? item.url : null,
                            m3u8: !isMpd && item.url ? item.url : null, 
                            clearkey: null,
                            drm: null,
                            customUserAgent: null,
                            customCookies: null
                        });
                    });
                }
            }
            return allChannels;
        }


        async function parseM3U(m3uContent) {
            const lines = m3uContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const channels = [];
            let currentChannel = {};

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                if (line.startsWith('#EXTINF:')) {
                    currentChannel = {
                        name: 'Unknown Channel',
                        logo: '',
                        mpd: null,
                        m3u8: null,
                        clearkey: null,
                        drm: null,
                        customUserAgent: null, 
                        customCookies: null    
                    };

                    const nameMatch = line.match(/,(.+)$/);
                    currentChannel.name = nameMatch ? nameMatch[1].trim() : 'Unknown Channel';
                    const logoMatch = line.match(/tvg-logo="?([^"]*)"?/i);
                    currentChannel.logo = logoMatch && logoMatch[1] ? logoMatch[1] : '';

                    let j = i + 1;
                    let urlFound = false;

                    while (j < lines.length) {
                        const subLine = lines[j];

                        if (subLine.startsWith('#EXTINF:')) {
                            break; 
                        } else if (subLine.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                            const clearkeyMatch = subLine.match(/license_key=([^:]+):([a-f0-9]+)/);
                            if (clearkeyMatch) {
                                currentChannel.clearkey = {
                                    keyId: clearkeyMatch[1],
                                    key: clearkeyMatch[2]
                                };
                            }
                        } else if (subLine.startsWith('#EXTVLCOPT:http-user-agent=')) {
                            const uaMatch = subLine.match(/http-user-agent=(.+)/);
                            if (uaMatch) {
                                currentChannel.customUserAgent = uaMatch[1].trim(); 
                            }
                        } else if (subLine.startsWith('#EXTHTTP:')) {
                            const cookieMatch = subLine.match(/{"cookie":"([^"]+)"}/);
                            if (cookieMatch) {
                                currentChannel.customCookies = cookieMatch[1];
                            }
                        } else if (!subLine.startsWith('#') && subLine.startsWith('http')) {
                            if (subLine.includes('.mpd')) {
                                currentChannel.mpd = subLine;
                            } else {
                                currentChannel.m3u8 = subLine;
                            }
                            urlFound = true;
                            i = j; 
                            break; 
                        }
                        j++;
                    }

                    if (urlFound) {
                        channels.push(currentChannel);
                    }
                }
            }
            
            return channels;
        }

        async function fetchAndParseData(tabId, url) {
            try {
                if (tabId === 'voot-tv') {
                    const response = await fetch(url);
                    const data = await response.json();
                    return mapVootTvChannels(data);
                }
                
                if (tabId === 'opplex-tv') {
                    const response = await fetch(url);
                    const data = await response.json();
                    return mapOpplexChannels(data);
                }

                if (url.endsWith('.json')) {
                    const response = await fetch(url);
                    return await response.json();
                } else if (url.endsWith('.m3u')) {
                    const response = await fetch(url);
                    const text = await response.text();
                    return await parseM3U(text);
                }

                console.error('Unsupported file format for URL:', url);
                return [];

            } catch (error) {
                console.error(`Failed to fetch or parse data for ${tabId}:`, error);
                showMessageBox("Data Loading Error", `Could not load channels for ${tabId}. The data source URL might be down or inaccessible.`);
                return [];
            }
        }

        function createChannelCard(channel) {
            const card = document.createElement('div');
            card.className = 'channel-card bg-gray-800 p-3 rounded-xl shadow-lg cursor-pointer hover:bg-gray-700/70 transform transition duration-300 flex flex-col items-center text-center';
            card.onclick = () => playChannel(channel);

            // Use a placeholder if logo is empty or missing
            const logoSrc = channel.logo && channel.logo.trim() !== '' ? channel.logo : 'https://placehold.co/200x150/2d3748/a0aec0?text=NO+LOGO';

            card.innerHTML = `
                <img src="${logoSrc}" alt="${channel.name} Logo" class="w-full h-auto max-h-24 object-contain rounded-lg mb-2" onerror="this.onerror=null;this.src='https://placehold.co/200x150/2d3748/a0aec0?text=NO+LOGO';">
                <p class="text-sm font-semibold text-gray-200 mt-1 truncate w-full">${channel.name}</p>
                <div class="text-xs text-gray-400 mt-1">
                    ${channel.mpd ? '<span class="px-2 py-0.5 bg-blue-500/20 text-blue-300 rounded-full font-medium">DASH</span>' : ''}
                    ${channel.m3u8 ? '<span class="px-2 py-0.5 bg-green-500/20 text-green-300 rounded-full font-medium">HLS</span>' : ''}
                    ${channel.clearkey || channel.drm ? '<span class="px-2 py-0.5 bg-red-500/20 text-red-300 rounded-full font-medium">DRM</span>' : ''}
                </div>
            `;
            return card;
        }

        async function loadAndDisplayChannels(tabId) {
            if (tabId === 'n-stream') {
                contentDisplay.innerHTML = '';
                contentDisplay.style.display = 'block'; 
                nStreamPlayerSection.classList.remove('hidden');
                nStreamPlayerSection.classList.add('flex');
                videoPlayerContainer.classList.add('hidden');
                loadRecentStreams(); // Load recent streams when manual tab is active
                return;
            }
            
            nStreamPlayerSection.classList.add('hidden');
            nStreamPlayerSection.classList.remove('flex');
            videoPlayerContainer.classList.add('hidden');
            contentDisplay.style.display = 'grid'; 

            const url = tabDataUrls[tabId];
            if (!url) {
                contentDisplay.innerHTML = '<p class="text-lg text-red-400 col-span-full text-center mt-8">Error: Channel list URL not configured.</p>';
                return;
            }

            contentDisplay.innerHTML = '<div class="loading-spinner mx-auto my-10 col-span-full"></div><p class="text-center col-span-full text-gray-400 mt-4">Loading channels...</p>';
            currentLoadedChannels = await fetchAndParseData(tabId, url);

            contentDisplay.innerHTML = ''; 
            if (currentLoadedChannels.length === 0) {
                contentDisplay.innerHTML = '<p class="text-lg text-gray-400 col-span-full text-center mt-8">No channels available for this category or data loading failed.</p>';
            } else {
                currentLoadedChannels.forEach(channel => {
                    contentDisplay.appendChild(createChannelCard(channel));
                });
            }
        }

        // --- Tab and Search Logic ---
        function setActiveTab(tabId) {
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('active');
                    currentTab = tabId;
                    loadAndDisplayChannels(tabId);
                    updateQueryParam('tab', tabId); 
                } else {
                    button.classList.remove('active');
                }
            });
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                setActiveTab(button.dataset.tab);
            });
        });

        // Search functionality 
        document.querySelector('.search-bar').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            const cards = contentDisplay.querySelectorAll('.channel-card');
            
            cards.forEach(card => {
                const name = card.querySelector('p').textContent.toLowerCase();
                if (name.includes(query)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        });
        
        // --- N Stream Logic ---
        streamTypeSelect.addEventListener('change', () => {
            if (streamTypeSelect.value === 'DASH') {
                drmControls.classList.remove('hidden');
                drmControls.classList.add('flex');
            } else {
                drmControls.classList.add('hidden');
                drmControls.classList.remove('flex');
                // Keep values in inputs, just hide the section
            }
        });

        playNStreamBtn.addEventListener('click', () => {
            const url = streamUrlInput.value.trim();
            if (!url) {
                showMessageBox("Input Required", "Please enter a Stream URL.");
                return;
            }

            const streamType = streamTypeSelect.value;
            const channelConfig = {
                name: 'Manual Stream',
                logo: 'https://placehold.co/200x150/2d3748/a0aec0?text=N+STREAM',
                m3u8: streamType === 'HLS' ? url : null,
                mpd: streamType === 'DASH' ? url : null,
                customUserAgent: null,
                customCookies: null,
                clearkey: null,
                drm: null
            };

            if (streamType === 'DASH') {
                const keyId = clearkeyIdInput.value.trim();
                const key = clearkeyKeyInput.value.trim();
                const licenseUrl = drmLicenseUrlInput.value.trim();

                if (keyId && key) {
                    channelConfig.clearkey = { keyId, key };
                } else if (licenseUrl) {
                    channelConfig.drm = { licenseUrl };
                }
            }

            playChannel(channelConfig);
            saveRecentStream(channelConfig);
            updateNStreamShareableUrl(channelConfig);
        });

        // --- Recent Streams Logic using LocalStorage (For N-Stream only) ---
        const MAX_RECENT_STREAMS = 8;
        const RECENT_STREAMS_KEY = 'pereLiveRecentStreams';

        function getRecentStreams() {
            try {
                const streams = JSON.parse(localStorage.getItem(RECENT_STREAMS_KEY) || '[]');
                return Array.isArray(streams) ? streams : [];
            } catch (e) {
                console.error("Error reading recent streams from local storage:", e);
                return [];
            }
        }

        function saveRecentStream(newStream) {
            let streams = getRecentStreams().filter(s => s.m3u8 !== newStream.m3u8 || s.mpd !== newStream.mpd);
            
            // Add new stream to the beginning
            streams.unshift(newStream);
            
            // Limit the list size
            streams = streams.slice(0, MAX_RECENT_STREAMS);
            
            try {
                localStorage.setItem(RECENT_STREAMS_KEY, JSON.stringify(streams));
                loadRecentStreams(); // Refresh the list
            } catch (e) {
                console.error("Error saving recent stream to local storage:", e);
            }
        }

        function removeRecentStream(url, isMpd) {
            let streams = getRecentStreams();
            streams = streams.filter(s => {
                if (isMpd) {
                    return s.mpd !== url;
                } else {
                    return s.m3u8 !== url;
                }
            });
            try {
                localStorage.setItem(RECENT_STREAMS_KEY, JSON.stringify(streams));
                loadRecentStreams(); 
            } catch (e) {
                console.error("Error removing recent stream from local storage:", e);
            }
        }

        function loadRecentStreams() {
            const streams = getRecentStreams();
            recentStreamsList.innerHTML = '';
            
            if (streams.length === 0) {
                document.getElementById('no-recent-streams').classList.remove('hidden');
                clearRecentStreamsBtn.classList.add('hidden');
                return;
            }
            
            document.getElementById('no-recent-streams').classList.add('hidden');
            clearRecentStreamsBtn.classList.remove('hidden');
            
            streams.forEach((stream) => {
                const streamUrl = stream.m3u8 || stream.mpd;
                const isMpd = !!stream.mpd;
                
                const button = document.createElement('button');
                button.className = 'recent-stream-btn flex items-center bg-gray-700 hover:bg-gray-600 text-gray-200 text-sm py-2 px-3 rounded-lg transition duration-200 shadow-md';
                
                button.innerHTML = `
                    <span class="recent-stream-url flex-grow mr-3" title="${streamUrl}">
                        ${isMpd ? 'DASH:' : 'HLS:'} ${streamUrl}
                    </span>
                    <span class="text-xs text-blue-400 font-semibold mr-2">${isMpd ? 'MPD' : 'M3U8'}</span>
                    <button data-url="${streamUrl}" data-mpd="${isMpd}" class="remove-stream-btn text-red-400 hover:text-red-300 font-bold text-lg leading-none" title="Remove">&times;</button>
                `;

                button.querySelector('.recent-stream-url').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    streamUrlInput.value = streamUrl;
                    streamTypeSelect.value = isMpd ? 'DASH' : 'HLS';
                    
                    // Trigger change to show/hide DRM controls
                    const changeEvent = new Event('change');
                    streamTypeSelect.dispatchEvent(changeEvent);

                    if (stream.clearkey) {
                        clearkeyIdInput.value = stream.clearkey.keyId || '';
                        clearkeyKeyInput.value = stream.clearkey.key || '';
                        drmLicenseUrlInput.value = '';
                    } else if (stream.drm) {
                         drmLicenseUrlInput.value = stream.drm.licenseUrl || '';
                         clearkeyIdInput.value = '';
                         clearkeyKeyInput.value = '';
                    } else {
                         drmLicenseUrlInput.value = '';
                         clearkeyIdInput.value = '';
                         clearkeyKeyInput.value = '';
                    }
                    showMessageBox("Stream Loaded", `Manual stream URL for ${isMpd ? 'DASH' : 'HLS'} has been loaded into the input fields.`);

                });

                button.querySelector('.remove-stream-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeRecentStream(streamUrl, isMpd);
                });

                recentStreamsList.appendChild(button);
            });
        }
        
        clearRecentStreamsBtn.addEventListener('click', () => {
            try {
                localStorage.removeItem(RECENT_STREAMS_KEY);
                loadRecentStreams();
                showMessageBox("Streams Cleared", "All recent manual streams have been removed.");
            } catch (e) {
                 showMessageBox("Error", "Could not clear all streams.");
            }
        });

        // --- Quality Selector Logic (Shaka only) ---
        function setupShakaQualitySelector() {
            if (!shakaPlayerInstance) return;

            qualitySelector.classList.remove('hidden');
            
            // Clear existing options
            qualitySelector.innerHTML = '<option value="auto">Auto</option>';

            const variants = shakaPlayerInstance.getVariantTracks();
            variants.sort((a, b) => b.height - a.height); // Sort by height descending

            const resolutions = new Set();
            variants.forEach(variant => {
                if (variant.height && !resolutions.has(variant.height)) {
                    resolutions.add(variant.height);
                    const option = document.createElement('option');
                    option.value = `${variant.height}`;
                    option.textContent = `${variant.height}p`;
                    qualitySelector.appendChild(option);
                }
            });
            
            // Set initial selection
            const activeVariant = shakaPlayerInstance.getVariantTracks().find(v => v.active);
            qualitySelector.value = activeVariant && activeVariant.height ? activeVariant.height : 'auto';


            // Event Listener for Manual Quality Change
            qualitySelector.onchange = (e) => {
                const selectedValue = e.target.value;
                if (selectedValue === 'auto') {
                    shakaPlayerInstance.configure({ abr: { enabled: true } });
                    shakaPlayerInstance.selectVariantTrack(null, true);
                    console.log('Switched to Automatic Quality (ABR enabled).');
                } else {
                    shakaPlayerInstance.configure({ abr: { enabled: false } });
                    const targetHeight = parseInt(selectedValue, 10);
                    const targetVariant = shakaPlayerInstance.getVariantTracks().find(v => v.height === targetHeight);

                    if (targetVariant) {
                        shakaPlayerInstance.selectVariantTrack(targetVariant, true);
                        console.log(`Manually set quality to ${targetHeight}p.`);
                    } else {
                        console.error(`Variant track for ${targetHeight}p not found.`);
                    }
                }
            };
        }
        
        // --- Initialization and URL Handling ---
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab') || 'fancode';
            const channelParam = urlParams.get('channel');
            const nStreamParam = urlParams.get('n');
            
            setActiveTab(tabParam); 

            if (channelParam && tabParam !== 'n-stream') {
                const channelName = decodeURIComponent(channelParam);
                
                // Wait for channels to load before attempting to play
                const checkAndPlay = () => {
                    if (currentLoadedChannels.length > 0) {
                        const targetChannel = currentLoadedChannels.find(c => c.name === channelName);
                        if (targetChannel) {
                            playChannel(targetChannel);
                        } else {
                            console.warn(`Channel "${channelName}" not found in tab "${tabParam}".`);
                            showMessageBox("Channel Not Found", `The shared channel link is invalid or the channel "${channelName}" is not available in the "${tabParam}" category.`);
                        }
                    } else if (contentDisplay.querySelector('.loading-spinner')) {
                        // If loading, retry shortly
                        setTimeout(checkAndPlay, 500); 
                    } else {
                         showMessageBox("Load Error", `Could not load data for tab "${tabParam}".`);
                    }
                };
                checkAndPlay();
            } else if (nStreamParam && tabParam === 'n-stream') {
                const fullStream = decodeURIComponent(nStreamParam);
                const [urlPart, paramsPart] = fullStream.split('|', 2);
                
                const channelConfig = {
                    name: 'Manual Shared Stream',
                    logo: 'https://placehold.co/200x150/2d3748/a0aec0?text=N+STREAM',
                    m3u8: urlPart.includes('.mpd') ? null : urlPart,
                    mpd: urlPart.includes('.mpd') ? urlPart : null,
                    customUserAgent: null,
                    customCookies: null,
                    clearkey: null,
                    drm: null
                };

                if (paramsPart) {
                    const params = new URLSearchParams(paramsPart);
                    const drmScheme = params.get('drmScheme');
                    const drmLicense = params.get('drmLicense');

                    if (drmScheme === 'clearkey' && drmLicense) {
                        const [keyId, key] = drmLicense.split(':');
                        channelConfig.clearkey = { keyId, key };
                        clearkeyIdInput.value = keyId;
                        clearkeyKeyInput.value = key;
                    } else if (drmLicense) {
                        channelConfig.drm = { licenseUrl: drmLicense };
                        drmLicenseUrlInput.value = drmLicense;
                    }
                }
                
                streamUrlInput.value = urlPart;
                streamTypeSelect.value = channelConfig.mpd ? 'DASH' : 'HLS';
                
                // Trigger change to show/hide DRM controls
                const changeEvent = new Event('change');
                streamTypeSelect.dispatchEvent(changeEvent);
                
                playChannel(channelConfig);
            }
            
             // Ensure recent streams are loaded for manual tab visibility
             if (tabParam === 'n-stream') {
                loadRecentStreams();
             }
        };

    </script>
</body>
</html>
