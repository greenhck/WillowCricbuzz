<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="referrer" content="no-referrer" />
    <!-- SEO Title -->
    <title>Perelive - Watch Live Streams & Channels Online</title>
    <!-- Meta Description -->
    <meta name="description" content="Perelive par dekhein latest live channels aur streams online. Entertainment, news, sports aur more, sab ek hi platform par. Join now!">
    <meta name="keywords" content="live streaming, online TV channels, watch live shows, Perelive, live sports, live news, free streaming, watch online, live entertainment, streaming platform">
    <meta name="google-site-verification" content="JoSAYJv7bUeJMbgQaTPDBpBerWVfYHO60UYENKygDcs" />

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Shaka Player for DASH/DRM -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/controls.min.css" crossorigin="anonymous"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.ui.min.js" crossorigin="anonymous"></script>

    <!-- Hls.js for HLS -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <!-- Firebase SDKs for Auth and Firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

        // Firebase Configuration (Using user-provided config as default)
        const userFirebaseConfig = {
            apiKey: "AIzaSyBz-v2-lbsBtk91ARf75ezB0NpWc7D0Zyg",
            authDomain: "perelive-c0ac2.firebaseapp.com",
            projectId: "perelive-c0ac2",
            storageBucket: "perelive-c0ac2.firebasestorage.app",
            messagingSenderId: "38475348473",
            appId: "1:38475348473:web:c2c8d121216a71944be528",
            measurementId: "G-5HCG31NZX2"
        };
        // IMPORTANT: Using global environment variables if available, otherwise using provided config.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-perelive-app';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global variables for the rest of the script to use
        window.fbApp = app;
        window.fbAuth = auth;
        window.fbDb = db;
        window.fbAppId = appId;
        window.fbServerTimestamp = serverTimestamp;

        // --- Active User Tracking Logic ---
        let globalUserId = null;
        const userActivityCollection = "live_users_presence"; // Dedicated public collection

        // 1. Authentication and Initial Setup
        async function initFirebaseAndAuth() {
            try {
                // Use custom token if provided, otherwise sign in anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
            }
        }

        // 2. Heartbeat Logic (Update presence every 60 seconds)
        function checkTimeAndHeartbeat() {
            const now = new Date();
            const currentHour = now.getHours(); // 0 (midnight) to 23
            // Check if time is between 12 AM (0) and 6 AM (exclusive, i.e., up to 5:59 AM)
            const isSleepTime = currentHour >= 0 && currentHour < 6;

            if (isSleepTime) {
                console.log("Sleep Time (12 AM - 6 AM): Heartbeat skipped.");
                return;
            }

            if (globalUserId) {
                // Update the user's document with the current timestamp
                const userDocRef = doc(db, userActivityCollection, globalUserId);
                setDoc(userDocRef, {
                    last_seen: serverTimestamp(), // Use server timestamp for accuracy
                    appId: appId
                }, { merge: true }).catch(e => console.error("Heartbeat update failed:", e));
            }
        }

        // 3. Live Counter Listener
        function setupLiveCounter() {
            const userCountDisplay = document.getElementById('user-count-display');
            const q = collection(db, userActivityCollection);

            onSnapshot(q, (snapshot) => {
                let activeUsers = 0;
                // Set the window for activity check to 2 minutes
                const twoMinutesAgo = Date.now() - (2 * 60 * 1000); 

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    // Client-side check: Only count users who have updated their presence in the last 2 minutes
                    if (data.last_seen && data.last_seen.toMillis() > twoMinutesAgo) { 
                         activeUsers++;
                    }
                });
                
                userCountDisplay.textContent = activeUsers;

                if (activeUsers < 1) { // Fallback if no docs are present or system is slow
                    userCountDisplay.textContent = '1';
                }
            }, (error) => {
                console.error("Error fetching live user count:", error);
                userCountDisplay.textContent = '...'; // Show error state
            });
        }

        // Handle Auth State Change
        onAuthStateChanged(auth, (user) => {
            if (user) {
                globalUserId = user.uid;
                console.log("Firebase signed in. User ID:", globalUserId);
                
                // Start initial heartbeat
                checkTimeAndHeartbeat();
                
                // Set up recurring heartbeat
                setInterval(checkTimeAndHeartbeat, 60000); // 60 seconds (1 minute)
                
                // Start the counter listener
                setupLiveCounter();
            }
        });

        // Start Auth process on load
        document.addEventListener('DOMContentLoaded', initFirebaseAndAuth);
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom styles for scrollbar in tabs */
        .tabs-container::-webkit-scrollbar {
            height: 0px;
        }
        .tabs-container::-webkit-scrollbar-thumb,
        .tabs-container::-webkit-scrollbar-track {
            background-color: transparent;
        }
        /* Loading spinner animation */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the Recent Stream URL display to be truncated */
        .recent-stream-url {
            display: block;
            max-width: 150px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            line-height: 1; /* Match button height */
        }
        /* Fix for quality selector scrolling over header */
        .shaka-player-container {
            position: relative;
        }
        /* High Z-index for quality selector */
        #quality-selector {
            z-index: 500 !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- Message Box Modal (New UI for Errors) -->
    <div id="message-box-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[1000] flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg shadow-2xl border-t-4 border-red-500">
            <h3 id="message-box-title" class="text-xl font-bold mb-3 text-red-400">स्ट्रीम एरर</h3>
            <p id="message-box-content" class="text-gray-300 mb-5 text-sm"></p>
            <button id="message-box-close-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg transition duration-200">ठीक है (बंद करें)</button>
        </div>
    </div>
    
    <!-- Info Modal (New Legal/Disclaimer Popup) -->
    <div id="info-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[1000] flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl p-6 w-full max-w-lg shadow-2xl border-t-4 border-blue-500">
            <h3 class="text-xl font-bold mb-3 text-blue-400">Disclaimer & Serving Status</h3>
            <p class="text-gray-300 mb-5 text-sm">
                This platform is purely for **serving** content links that are already **publicly available** on the internet. 
                We **do not host or upload** any streaming content, video files, or protected material. 
                Users are responsible for verifying the legal rights of the streams they access.
            </p>
            <button id="info-modal-close-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition duration-200">Close</button>
        </div>
    </div>


    <!-- Header Section (Redesigned) -->
    <header class="bg-black text-white px-4 py-2 text-center sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <!-- Left: Logo/Title -->
            <h1 class="text-lg sm:text-xl font-bold text-blue-400 whitespace-nowrap">PereLive</h1>

            <!-- Center: Search Bar -->
            <div class="flex-grow max-w-md mx-4 hidden sm:block">
                <div class="relative">
                    <input type="text" placeholder="Search Channels..." class="search-bar w-full py-1.5 px-4 bg-gray-800 border border-gray-700 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Right: Icons (Telegram & Info) -->
            <div class="flex items-center space-x-3">
                
                <!-- Live User Count -->
                <div class="flex items-center text-xs sm:text-sm text-green-400 bg-gray-800 px-3 py-1 rounded-full shadow-inner">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 mr-1 text-red-500 animate-pulse">
                        <path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.316 2.784-1.664l11.54 6.347a1.125 1.125 0 0 1 0 1.991l-11.54 6.347c-1.255.652-2.784-.236-2.784-1.664V5.653Z" clip-rule="evenodd" />
                    </svg>
                    <span id="user-count-display" class="font-semibold">...</span> Live
                </div>
                
                <!-- Telegram Icon -->
                <a href="https://t.me/sportslivelink18" target="_blank" title="Join Telegram Channel" class="text-white hover:text-blue-400 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M19.825 5.862c.277-.2.433-.497.464-.813a1.01 1.01 0 0 0-.214-.852c-.3-.265-.724-.316-1.076-.134l-14 6.5A1 1 0 0 0 4 12.562l2.915 2.915 6.273-3.92-4.99 4.757a1 1 0 0 0-.012 1.414c.265.265.69.316 1.056.12l3.8-2.074 4.39 4.39a1 1 0 0 0 1.707.037l2.5-12.5a1 1 0 0 0-.065-.898Z" />
                    </svg>
                </a>
                
                <!-- Info Icon (?) -->
                <button id="info-btn" title="Disclaimer" class="text-white hover:text-blue-400 transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM12 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V9a.75.75 0 0 1 .75-.75ZM12 15a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Search Bar (Only shown on small screens) -->
        <div class="sm:hidden mt-2">
            <input type="text" placeholder="Search Channels..." class="search-bar w-full py-1.5 px-4 bg-gray-800 border border-gray-700 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
    </header>


    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto w-full p-2 sm:p-4">
        
        <!-- Tabs for Channel Sources -->
        <div class="tabs-container flex overflow-x-auto whitespace-nowrap space-x-2 sm:space-x-4 mb-4 pb-2">
            <button class="tab-button text-sm sm:text-base font-medium py-2 px-3 sm:px-4 rounded-lg transition duration-150 text-gray-400 hover:text-white" data-tab="pere-sports">Pere Sports</button>
            <button class="tab-button text-sm sm:text-base font-medium py-2 px-3 sm:px-4 rounded-lg transition duration-150 text-gray-400 hover:text-white" data-tab="jio-tv">Jio TV</button>
            <button class="tab-button text-sm sm:text-base font-medium py-2 px-3 sm:px-4 rounded-lg transition duration-150 text-gray-400 hover:text-white" data-tab="zee-network">Zee Network</button>
            <button class="tab-button text-sm sm:text-base font-medium py-2 px-3 sm:px-4 rounded-lg transition duration-150 text-gray-400 hover:text-white" data-tab="fancode">FanCode</button>
            <button class="tab-button text-sm sm:text-base font-medium py-2 px-3 sm:px-4 rounded-lg transition duration-150 text-gray-400 hover:text-white" data-tab="voot-tv">Voot TV</button>
            <button class="tab-button text-sm sm:text-base font-medium py-2 px-3 sm:px-4 rounded-lg transition duration-150 text-gray-400 hover:text-white" data-tab="opplex-tv">Opplex TV</button>
            <button class="tab-button text-sm sm:text-base font-medium py-2 px-3 sm:px-4 rounded-lg transition duration-150 text-gray-400 hover:text-white" data-tab="pirates-tv">Pirates TV</button>
            <button class="tab-button text-sm sm:text-base font-medium py-2 px-3 sm:px-4 rounded-lg transition duration-150 text-gray-400 hover:text-white" data-tab="n-stream">N Stream</button>
        </div>
        
        <!-- Video Player Container (Edge to Edge, Hidden by Default) -->
        <div id="video-player-container" class="hidden flex-col w-full bg-black rounded-xl overflow-hidden shadow-2xl mb-6 relative aspect-video">
            
            <!-- Close Button, Share Button, and Quality Selector -->
            <div class="absolute top-2 right-2 flex space-x-2 z-10">
                
                <!-- Share Button -->
                <button id="share-btn" class="bg-gray-800 bg-opacity-70 hover:bg-opacity-90 text-white p-2 rounded-full shadow-lg transition duration-200" title="Share Channel Link">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M15.75 4.5a3 3 0 1 1.411 2.89 1.5 1.5 0 0 0-.411 1.139v9a1.5 1.5 0 0 0 1.5 1.5h1.5a.75.75 0 0 1 0 1.5h-1.5A3 3 0 0 1 14.25 18v-9a1.5 1.5 0 0 0-.411-1.139 3.001 3.001 0 0 1 .411-2.89ZM7.5 6a3 3 0 1 0 0 6 3 3 0 0 0 0-6Zm-1.259 8.653a1.5 1.5 0 0 0-.174 1.488l.865 1.44a3 3 0 0 1 3.197 2.454 3 3 0 0 0 5.487-1.464c-.035-.121-.082-.24-.139-.356A2.992 2.992 0 0 1 12 15a2.99 2.99 0 0 1-2.99-2.99c.002-.12.012-.239.03-.357A1.5 1.5 0 0 0 6.241 14.653Z" clip-rule="evenodd" />
                    </svg>
                </button>
                
                <!-- Quality Selector for Shaka Player -->
                <select id="quality-selector" class="shaka-select hidden bg-gray-800 bg-opacity-70 text-white rounded-full p-2 text-sm focus:outline-none"></select>
                
                <!-- Close Player Button -->
                <button id="close-player-btn" class="bg-red-600 bg-opacity-70 hover:bg-opacity-90 text-white p-2 rounded-full shadow-lg transition duration-200" title="Close Player">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Shaka Player Container for DASH (MPD) -->
            <div id="shaka-video-container" data-shaka-player-container style="display: none; height: 100%; width: 100%;">
                <video id="shaka-video" data-shaka-player class="w-full h-full" autoplay playsinline></video>
            </div>
            
            <!-- Native/HLS.js Video Element for M3U8/Generic -->
            <video id="hls-video" class="w-full h-full" style="display: none;" autoplay playsinline controls></video>
        </div>


        <!-- N Stream Player Section -->
        <div id="n-stream-player-section" class="hidden flex-col bg-gray-800 p-4 sm:p-6 rounded-xl shadow-2xl">
            <h2 class="text-xl font-semibold mb-4 text-blue-400">N Stream (Custom URL)</h2>
            <div class="space-y-4">
                
                <!-- URL Input -->
                <div>
                    <label for="stream-url-input" class="block text-sm font-medium text-gray-300">स्ट्रीम URL (MPD या M3U8)</label>
                    <input type="text" id="stream-url-input" placeholder="https://stream.example.com/live/index.mpd" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <!-- Type Selection -->
                <div>
                    <label for="stream-type-select" class="block text-sm font-medium text-gray-300">स्ट्रीम प्रकार चुनें</label>
                    <select id="stream-type-select" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="HLS">HLS (M3U8)</option>
                        <option value="DASH">DASH (MPD)</option>
                    </select>
                </div>

                <!-- DRM/ClearKey Controls (Initially Hidden) -->
                <div id="drm-controls" class="hidden flex-col space-y-4 border-t border-gray-700 pt-4">
                    <h3 class="text-base font-medium text-red-400">DRM / एन्क्रिप्शन सेटिंग्स (केवल DASH के लिए)</h3>
                    <!-- ClearKey Inputs -->
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label for="clearkey-id-input" class="block text-sm font-medium text-gray-300">ClearKey ID (Key ID)</label>
                            <input type="text" id="clearkey-id-input" placeholder="e.g., 000000..." class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div class="flex-1">
                            <label for="clearkey-key-input" class="block text-sm font-medium text-gray-300">ClearKey (Key)</label>
                            <input type="text" id="clearkey-key-input" placeholder="e.g., 111111..." class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-red-500 focus:border-red-500">
                        </div>
                    </div>
                    <!-- Widevine/DRM License URL -->
                    <div>
                        <label for="drm-license-url-input" class="block text-sm font-medium text-gray-300">DRM License URL (Widevine/PlayReady)</label>
                        <input type="text" id="drm-license-url-input" placeholder="https://license.example.com" class="w-full mt-1 p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <p class="text-xs text-gray-500 mt-1">नोट: ClearKey या License URL में से किसी एक का ही उपयोग करें।</p>
                    </div>
                </div>

                <!-- Play Button -->
                <button id="play-n-stream-btn" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-xl">
                    स्ट्रीम चलाएँ
                </button>
            </div>
            
            <!-- Recent Streams List -->
            <div class="mt-8">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold text-gray-300">हालिया स्ट्रीम्स</h3>
                    <button id="clear-recent-streams-btn" class="text-xs text-red-400 hover:text-red-300 hidden">
                        हालिया स्ट्रीम्स साफ़ करें
                    </button>
                </div>
                <div id="recent-streams-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <p id="no-recent-streams" class="text-sm text-gray-500">कोई हालिया स्ट्रीम नहीं।</p>
                </div>
            </div>
        </div>

        <!-- Channel Display Grid -->
        <div id="content-display" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
            <!-- Channels will be loaded here -->
        </div>
    </main>

    <!-- Footer (Optional: Keep it simple) -->
    <footer class="bg-gray-800 text-center p-3 text-xs text-gray-500 mt-auto shadow-inner">
        &copy; 2024 PereLive. All rights reserved. Content links are for testing purposes only.
    </footer>

    <script>
        // --- Global State and Data ---
        let shakaPlayerInstance = null;
        let hlsPlayer = null;
        let shakaNetworkingFilter = null;
        let currentTab = 'pere-sports';
        let currentLoadedChannels = [];
        const tabDataUrls = {
            'pere-sports': 'pereSports.m3u',
            'jio-tv': 'jioTv.m3u',
            'zee-network': 'zeeNetwork.json',
            'fancode': 'fancode.json',
            'voot-tv': 'vootTvP.json',
            'opplex-tv': 'opplexPere.json',
            'pirates-tv': 'piratesTv.m3u',
            'n-stream': 'N-Stream' // Placeholder, no external data file
        };
        
        // --- DOM Elements ---
        const videoPlayerContainer = document.getElementById('video-player-container');
        const shakaVideoContainer = document.getElementById('shaka-video-container');
        const shakaVideoElement = document.getElementById('shaka-video');
        const hlsVideoElement = document.getElementById('hls-video');
        const contentDisplay = document.getElementById('content-display');
        const tabButtons = document.querySelectorAll('.tab-button');
        const closePlayerBtn = document.getElementById('close-player-btn');
        const shareBtn = document.getElementById('share-btn');
        const qualitySelector = document.getElementById('quality-selector');
        
        // N-Stream specific elements
        const nStreamPlayerSection = document.getElementById('n-stream-player-section');
        const streamUrlInput = document.getElementById('stream-url-input');
        const streamTypeSelect = document.getElementById('stream-type-select');
        const drmControls = document.getElementById('drm-controls');
        const clearkeyIdInput = document.getElementById('clearkey-id-input');
        const clearkeyKeyInput = document.getElementById('clearkey-key-input');
        const drmLicenseUrlInput = document.getElementById('drm-license-url-input');
        const playNStreamBtn = document.getElementById('play-n-stream-btn');
        const recentStreamsList = document.getElementById('recent-streams-list');
        const clearRecentStreamsBtn = document.getElementById('clear-recent-streams-btn');
        
        // Modal elements
        const messageBoxModal = document.getElementById('message-box-modal');
        const messageBoxTitle = document.getElementById('message-box-title');
        const messageBoxContent = document.getElementById('message-box-content');
        const messageBoxCloseBtn = document.getElementById('message-box-close-btn');
        const infoModal = document.getElementById('info-modal');
        const infoBtn = document.getElementById('info-btn');
        const infoModalCloseBtn = document.getElementById('info-modal-close-btn');


        // --- Utility Functions ---
        function showMessageBox(title, content) {
            messageBoxTitle.textContent = title;
            messageBoxContent.textContent = content;
            messageBoxModal.classList.remove('hidden');
        }

        function closeMessageBox() {
            messageBoxModal.classList.add('hidden');
        }

        function openInfoModal() {
            infoModal.classList.remove('hidden');
        }

        function closeInfoModal() {
            infoModal.classList.add('hidden');
        }

        function updateQueryParam(key, value) {
            const url = new URL(window.location);
            if (value === null) {
                url.searchParams.delete(key);
            } else {
                url.searchParams.set(key, value);
            }
            window.history.pushState({}, '', url);
        }

        function updateChannelShareableUrl(channelName) {
            updateQueryParam('tab', currentTab);
            updateQueryParam('channel', encodeURIComponent(channelName));
            updateQueryParam('n', null); // Clear N-Stream if set
        }

        function updateNStreamShareableUrl(channelConfig) {
            updateQueryParam('tab', 'n-stream');
            updateQueryParam('channel', null); // Clear regular channel if set
            
            let nValue = channelConfig.mpd || channelConfig.m3u8;
            const params = [];
            
            if (channelConfig.clearkey && channelConfig.clearkey.keyId && channelConfig.clearkey.key) {
                // ClearKey format: drmScheme=clearkey&drmLicense=KID:KEY
                params.push(`drmScheme=clearkey`);
                params.push(`drmLicense=${channelConfig.clearkey.keyId}:${channelConfig.clearkey.key}`);
            } else if (channelConfig.drm && channelConfig.drm.licenseUrl) {
                // Widevine format: drmScheme=widevine&drmLicense=LicenseURL
                params.push(`drmScheme=widevine`);
                params.push(`drmLicense=${channelConfig.drm.licenseUrl}`);
            }

            if (params.length > 0) {
                nValue += '|' + params.join('&');
            }
            
            updateQueryParam('n', encodeURIComponent(nValue));
        }

        function resetPlayers() {
            // Stop and destroy HLS.js
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            
            // Stop and destroy Shaka Player
            if (shakaPlayerInstance) {
                shakaPlayerInstance.unload().catch(() => {});
                
                // Unregister network filter if it exists
                if (shakaNetworkingFilter) {
                    shakaPlayerInstance.getNetworkingEngine().unregisterRequestFilter(shakaNetworkingFilter);
                    shakaNetworkingFilter = null;
                }
            }

            // Stop native video elements
            shakaVideoElement.pause();
            shakaVideoElement.removeAttribute('src');
            shakaVideoElement.load();
            hlsVideoElement.pause();
            hlsVideoElement.removeAttribute('src');
            hlsVideoElement.load();

            // Hide quality selector
            qualitySelector.classList.add('hidden');
        }

        function closePlayer() {
            resetPlayers();
            videoPlayerContainer.classList.add('hidden');
            videoPlayerContainer.classList.remove('flex');
            updateQueryParam('tab', currentTab);
            updateQueryParam('channel', null);
            updateQueryParam('n', null);
        }

        // --- Shaka Player Initialization & Error Handling ---
        function initShakaPlayer() {
            // Check if shaka is available
            if (!shaka || !shaka.Player.is */* ) {
                console.error('Shaka Player is not available.');
                return;
            }
            
            // Create player instance
            shakaPlayerInstance = new shaka.Player(shakaVideoElement);
            
            // Configure ABR (Adaptive Bitrate) settings
            shakaPlayerInstance.configure({
                abr: {
                    enabled: true, // Default to ABR enabled
                },
                streaming: {
                    lowLatencyMode: true,
                    // Buffer target set low for live streams
                    bufferBehind: 2,
                    rebufferingGoal: 0.5,
                },
                // Add a default Widevine server just in case
                drm: {
                     servers: {
                         'com.widevine.alpha': 'https://license.example.com/widevine'
                     }
                }
            });
            
            // Error handling function
            shakaPlayerInstance.addEventListener('error', onError);
            
            // Initialize Shaka UI (Controls)
            const ui = new shaka.ui.Overlay(shakaPlayerInstance, shakaVideoContainer, shakaVideoElement);
            // Hide the default resolution selector, we use a custom one
            ui.get  // <-- This was a previous unfinished line, removing it to be safe
            
            console.log('Shaka Player initialized and configured.');
        }
        
        function onError(error) {
            // The error object comes from the event.
            console.error('Shaka Player Error Code:', error.code, 'Error Message:', error.detail ? error.detail.message : error.message);
            
            // Only show a message box for unrecoverable errors like 403, 404, or DRM errors
            if (error.code === 403 || error.code === 404 || error.code === 6001) {
                showMessageBox("स्ट्रीम लोड नहीं हुई", "वीडियो स्ट्रीम लोड करने में त्रुटि आई है। यह URL अमान्य हो सकता है या आपके IP के लिए अनुमत नहीं हो सकता है।");
                closePlayer();
            }
        }
        
        // --- Player Core Functions ---
        // Disable Auto Fullscreen/Autoplay Tweaks (Passive Playback Logic)
        function handlePlaybackLogic(video, isShaka, channelName = null) {
            let hasUserInteracted = false;
            const enableSoundOnInteraction = () => {
                if (!hasUserInteracted) {
                    video.muted = false;
                    hasUserInteracted = true;
                    video.volume = 0.8;
                    console.log('Sound enabled after user interaction (User Clicked)');
                }
            };
            
            // Listen for any user interaction on the whole document
            ['click', 'touchstart', 'keydown'].forEach(event => {
                document.addEventListener(event, enableSoundOnInteraction, { once: true });
            });

            // Set initial muted state for attempted autoplay
            video.muted = true;

            const attemptAutoplay = () => {
                video.play().then(() => {
                    console.log('Autoplay successful (muted)!');
                    // Update sharable URL on successful playback for regular channels
                    if (!isShaka && channelName && currentTab !== 'n-stream') {
                        updateChannelShareableUrl(channelName);
                    }
                }).catch(e => {
                    console.warn('Autoplay failed, user interaction required.', e);
                });
            };

            // Attempt to autoplay immediately
            if (video.readyState >= 3) {
                attemptAutoplay();
            } else {
                video.addEventListener('canplay', attemptAutoplay, { once: true });
            }

            // Only for Shaka Player: When the player is fully loaded and ready
            if (isShaka) {
                if (shakaPlayerInstance) {
                    
                    // Use a dedicated function for the listener
                    const shakaLoadedListener = () => {
                        // Update sharable URL on successful playback for regular channels
                        if (channelName && currentTab !== 'n-stream') {
                            updateChannelShareableUrl(channelName);
                        }
                        // Clean up listener after first use
                        shakaPlayerInstance.removeEventListener('loaded', shakaLoadedListener);
                    };

                    // Check if already loaded, or listen for loaded event
                    if (shakaPlayerInstance.isLoaded()) {
                         if (channelName && currentTab !== 'n-stream') {
                            updateChannelShareableUrl(channelName);
                        }
                    } else {
                        shakaPlayerInstance.addEventListener('loaded', shakaLoadedListener);
                    }
                }
            }
        } // <--- IMPORTANT: The function is now correctly closed here.

        // playChannel function updated to handle custom User-Agent and Cookies from M3U parsing
        async function playChannel(channel) {
            console.log('Playing channel:', channel.name);
            // Edge-to-Edge Player: Ensure container uses full width
            videoPlayerContainer.classList.remove('hidden');
            videoPlayerContainer.classList.add('flex');
            nStreamPlayerSection.classList.add('hidden'); // Hide N-Stream section
            nStreamPlayerSection.classList.remove('flex');

            resetPlayers(); // Clears previous player and network filter

            try {
                // --- Common Spoofing Headers for Shaka/HLS ---
                const fixedSpoofHeaders = {
                    'Referer': 'https://www.jiotv.com/',
                    // Default User-Agent for JioTV/similar links
                    'User-Agent': "plaYtv/7.1.5 (Linux;Android 13) ExoPlayerLib/2.11.6"
                };

                // Override fixed headers with custom channel headers (extracted from M3U)
                const requestHeaders = { ...fixedSpoofHeaders };

                if (channel.customUserAgent) {
                    // Use custom User-Agent if provided in M3U
                    requestHeaders['User-Agent'] = channel.customUserAgent;
                }

                if (channel.customCookies) {
                    // Use custom Cookies if provided in M3U
                    requestHeaders['Cookie'] = channel.customCookies;
                }

                // Priority 1: HLS (m3u8 or generic non-MPD link)
                if (channel.m3u8) {
                    shakaVideoContainer.style.display = 'none';
                    hlsVideoElement.style.display = 'block';

                    if (Hls.isSupported()) {
                        hlsPlayer = new Hls({
                            liveSyncDuration: 3,
                            liveMaxLatencyDuration: 10,
                            // Use xhrSetup to include headers for HLS.js
                            xhrSetup: function(xhr, url) {
                                for (const header in requestHeaders) {
                                    xhr.setRequestHeader(header, requestHeaders[header]);
                                }
                                console.log(`[HLS Filter] Request URL: ${url}, Final Headers:`, requestHeaders);
                            }
                        });
                        hlsPlayer.loadSource(channel.m3u8);
                        hlsPlayer.attachMedia(hlsVideoElement);
                        hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
                            console.log('HLS manifest parsed (hls.js)!');
                            handlePlaybackLogic(hlsVideoElement, false, channel.name);
                        });
                        hlsPlayer.on(Hls.Events.ERROR, function(event, data) {
                            console.error('HLS.js Error:', data);
                            // REMOVED: Aggressive closePlayer() calls as requested
                            if (data.fatal) {
                                switch(data.type) {
                                case Hls.ErrorTypes.NETWORK_ERROR:
                                    console.error("fatal network error, trying to recover");
                                    // Removed showMessageBox and closePlayer: allowing HLS.js internal recovery
                                    break;
                                case Hls.ErrorTypes.MEDIA_ERROR:
                                    console.error("fatal media error, trying to recover");
                                    // Removed showMessageBox and closePlayer: allowing HLS.js internal recovery
                                    break;
                                default:
                                    console.error('HLS video playback failed.');
                                    break;
                                }
                            }
                        });
                        console.log('HLS M3U8 URL loading (hls.js):', channel.m3u8);
                    } else if (hlsVideoElement.canPlayType('application/vnd.apple.mpegurl')) {
                        hlsVideoElement.src = channel.m3u8;
                        hlsVideoElement.addEventListener('loadedmetadata', () => handlePlaybackLogic(hlsVideoElement, false, channel.name));
                        console.log('Using browser\'s native HLS support.');
                    } else {
                        console.error('आपका ब्राउज़र HLS वीडियो चलाने का समर्थन नहीं करता है।');
                        showMessageBox("ब्राउज़र संगतता त्रुटि", "आपका ब्राउज़र HLS वीडियो चलाने का समर्थन नहीं करता है।");
                        closePlayer();
                    }
                }
                // Priority 2: DASH (mpd)
                else if (channel.mpd) {
                    shakaVideoContainer.style.display = 'block';
                    hlsVideoElement.style.display = 'none';

                    if (!shakaPlayerInstance) {
                        console.error('Shaka Player instance is not ready!');
                        closePlayer();
                        return;
                    }

                    // --- Build DRM Configuration ONLY (Streaming config is set globally for faster performance) ---
                    const shakaConfig = {
                        drm: {} // Default empty DRM
                    };

                    // DRM Configuration
                    if (channel.clearkey && channel.clearkey.keyId && channel.clearkey.key) {
                        // Note: Keys are expected to be clean (no dashes) from parseM3U now
                        const keyId = channel.clearkey.keyId.replace(/-/g, '').toLowerCase();
                        const key = channel.clearkey.key.replace(/-/g, '').toLowerCase();
                        shakaConfig.drm.clearKeys = { [keyId]: key };
                        console.log('ClearKey DRM configured (Shaka Player).');
                    } else if (channel.drm && channel.drm.licenseUrl) {
                        const servers = {};
                        // Only supporting Widevine by default if type is not specified
                        servers['com.widevine.alpha'] = channel.drm.licenseUrl;
                        shakaConfig.drm.servers = servers;
                        shakaConfig.drm.advanced = {};
                        console.log(`DRM configured (Shaka Player) License URL: ${channel.drm.licenseUrl}`);
                    } else {
                        console.log('No ClearKey or DRM configured for this DASH channel.');
                    }

                    shakaPlayerInstance.configure(shakaConfig); // Apply ONLY DRM configuration

                    // --- Use registerRequestFilter for dynamic headers (Correct Method) ---
                    // Define the filter function to set the dynamic headers on every request
                    shakaNetworkingFilter = (type, request) => {
                        // 1. Apply all headers (Referer, User-Agent, Cookie) from the dynamic requestHeaders object
                        Object.assign(request.headers, requestHeaders);

                        // 2. Append the full cookie string to the URL query parameters
                        const customCookieString = requestHeaders['Cookie'];

                        if (customCookieString &&
                            (type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
                              type === shaka.net.NetworkingEngine.RequestType.SEGMENT)) {

                            // Check if the URL already contains the cookie token (to avoid double appending)
                            if (!request.uris[0].includes('__hdnea__=')) {
                                 const separator = request.uris[0].includes('?') ? '&' : '?';
                                // The customCookieString should contain the full token string (e.g., __hdnea__=st=...)
                                // The token is appended directly as the value of the 'Cookie' header is the signed string itself.
                                request.uris[0] += separator + customCookieString; 
                             }
                        }

                        // CRITICAL DEBUG LOG: Check final URL and headers
                        console.log(`[Shaka Filter] Request Type: ${type}, Final URL: ${request.uris[0]}, Final Headers:`, request.headers);
                    };

                    // Register the filter
                    shakaPlayerInstance.getNetworkingEngine().registerRequestFilter(shakaNetworkingFilter);
                    console.log('Dynamic network filter registered with User-Agent, Cookie Header, and URL signing.');

                    console.log('DASH MPD URL loading (Shaka Player):', channel.mpd);
                    await shakaPlayerInstance.load(channel.mpd);
                    console.log('Video loaded (Shaka Player)!');
                    handlePlaybackLogic(shakaVideoElement, true, channel.name);
                    setupShakaQualitySelector(); // Setup quality selector after load
                } else {
                    console.error('इस चैनल के लिए कोई मान्य स्ट्रीम URL (MPD या M3U8/Generic) नहीं मिला।');
                    showMessageBox("URL त्रुटि", "इस चैनल के लिए कोई मान्य स्ट्रीम URL (MPD या M3U8/Generic) नहीं मिला।");
                    closePlayer();
                }
            } catch (e) {
                // Shaka Player error objects (like the 403 or heavy buffering errors) are caught here.
                onError(e);
            }
        }

        // --- Channel Mapping Function for Voot TV (and similar JSON structures) ---
        function mapVootTvChannels(data) {
            if (!Array.isArray(data)) {
                console.error("Voot TV data is not an array:", data);
                return [];
            }
            return data.map(item => ({
                name: item.channel_name || item.id,
                logo: item.logo || 'https://placehold.co/200x150/2d3748/a0aec0?text=Voot+TV',
                // Updated mapping logic (Issue #4 fix area)
                mpd: (item.url && item.url.includes('.mpd')) ? item.url : null,
                m3u8: item.url && !item.url.includes('.mpd') ? item.url : null, // Assuming generic link is HLS/Generic if not MPD
                clearkey: null,
                drm: null,
                customUserAgent: null,
                customCookies: null
            }));
        }

        // --- NEW: Channel Mapping Function for Opplex TV (nested JSON structure) ---
        function mapOpplexChannels(data) {
            let allChannels = [];
            if (typeof data !== 'object' || data === null) {
                console.error("Opplex TV data is not a valid object:", data);
                return [];
            }

            // Iterate over each category key (e.g., "PAKISTAN | ENTERTAINMENT")
            for (const category in data) {
                if (Array.isArray(data[category])) {
                    data[category].forEach(item => {
                        // The URLs are generic PHP links which should be tested with HLS/Generic player
                        const isMpd = item.url && item.url.includes('.mpd');

                        allChannels.push({
                            // UPDATED: Only use the original name, remove the category/country prefix
                            // FIX: Removing the entire 'Welcome' block for cleaner names
                            name: item.name.replace(/•●★--- Welcome ----★●•/g, '').trim() || 'Opplex Channel',
                            logo: item.logo || 'https://placehold.co/200x150/2d3748/a0aec0?text=Opplex+TV',
                            mpd: isMpd ? item.url : null,
                            m3u8: !isMpd && item.url ? item.url : null, // Treat generic links as m3u8/generic
                            clearkey: null,
                            drm: null,
                            customUserAgent: null,
                            customCookies: null
                        });
                    });
                }
            }
            return allChannels;
        }

        // --- Channel Loading Functions ---
        async function parseM3U(m3uContent) {
            const lines = m3uContent.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const channels = [];
            let currentChannel = {};

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                if (line.startsWith('#EXTINF:')) {
                    currentChannel = {
                        name: 'Unknown Channel',
                        logo: '',
                        mpd: null,
                        m3u8: null,
                        clearkey: null,
                        drm: null,
                        customUserAgent: null, // New field for extracted User-Agent
                        customCookies: null    // New field for extracted Cookie
                    };

                    const nameMatch = line.match(/,(.+)$/);
                    currentChannel.name = nameMatch ? nameMatch[1].trim() : 'Unknown Channel';
                    const logoMatch = line.match(/tvg-logo="?([^"]*)"?/i);
                    currentChannel.logo = logoMatch && logoMatch[1] ? logoMatch[1] : '';

                    let j = i + 1;
                    let urlFound = false;

                    // Parse metadata lines until a URL or next EXTINF is hit
                    while (j < lines.length) {
                        const subLine = lines[j];

                        if (subLine.startsWith('#EXTINF:')) {
                            // Hit the next channel entry before finding a URL, stop and break
                            break;
                        } else if (subLine.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                            // ClearKey handling
                            const clearkeyMatch = subLine.match(/license_key=([^:]+):([a-f0-9]+)/);
                            if (clearkeyMatch) {
                                currentChannel.clearkey = {
                                    keyId: clearkeyMatch[1],
                                    key: clearkeyMatch[2]
                                };
                            }
                        } else if (subLine.startsWith('#EXTVLCOPT:http-user-agent=')) {
                            // Custom User-Agent handling
                            const uaMatch = subLine.match(/http-user-agent=(.+)/);
                            if (uaMatch) {
                                // Capture the UA string (e.g., plaYtv/7.1.3 ...)
                                currentChannel.customUserAgent = uaMatch[1].trim();
                            }
                        } else if (subLine.startsWith('#EXTHTTP:')) {
                            // Custom Cookie handling
                            const cookieMatch = subLine.match(/{"cookie":"([^"]+)"}/);
                            if (cookieMatch) {
                                // Capture the raw cookie string (__hdnea__=...)
                                currentChannel.customCookies = cookieMatch[1];
                            }
                        } else if (!subLine.startsWith('#') && subLine.startsWith('http')) {
                            // Found the URL line
                            if (subLine.includes('.mpd')) {
                                // For JioStar, use the full URL including query params
                                currentChannel.mpd = subLine;
                            } else {
                                // If it's a URL but not MPD, assume it's HLS (m3u8).
                                currentChannel.m3u8 = subLine;
                            }
                            urlFound = true;
                            i = j; // Update main loop index to skip metadata/url lines
                            break; // Exit inner while loop
                        }
                        j++;
                    }

                    if (urlFound) {
                        channels.push(currentChannel);
                    }
                    // If URL not found, currentChannel is discarded, and the loop continues from the original 'i' or adjusted 'i'
                }
            }
            return channels;
        }

        function displayChannels(channels) {
            currentLoadedChannels = channels;
            contentDisplay.innerHTML = '';
            if (channels.length === 0) {
                contentDisplay.innerHTML = `<p class="text-center text-gray-400 p-4">कोई चैनल/मैच नहीं मिला।</p>`;
                return;
            }
            // Mobile grid is 2 cols (grid-cols-2) as requested
            contentDisplay.classList.remove('grid-cols-2', 'sm:grid-cols-3', 'md:grid-cols-4', 'lg:grid-cols-5');
            contentDisplay.classList.add('grid-cols-2', 'sm:grid-cols-3', 'md:grid-cols-4', 'lg:grid-cols-5');

            channels.forEach(channel => {
                const channelCard = document.createElement('div');
                channelCard.classList.add('channel-card', 'bg-gray-800', 'rounded-lg', 'overflow-hidden', 'shadow-lg', 'cursor-pointer', 'transform', 'transition-transform', 'duration-200', 'hover:-translate-y-1', 'hover:shadow-2xl');
                channelCard.innerHTML = `
                    <img src="${channel.logo || 'https://placehold.co/200x150/2d3748/a0aec0?text=No+Image'}" onerror="this.onerror=null;this.src='https://placehold.co/200x150/2d3748/a0aec0?text=No+Image';" alt="${channel.name}" class="w-full h-32 sm:h-40 object-cover">
                    <h3 class="p-2 sm:p-3 text-sm sm:text-base font-semibold text-center truncate">${channel.name}</h3>
                `;
                channelCard.addEventListener('click', () => {
                    playChannel(channel);
                    // Update URL immediately on user click, actual stream shareable update happens on success
                    updateChannelShareableUrl(channel.name);
                });
                contentDisplay.appendChild(channelCard);
            });
        }

        async function loadAndDisplayChannels(tabName, channelToPlay = null) {
            currentTab = tabName;

            // Hide all special sections by default
            nStreamPlayerSection.classList.add('hidden');
            nStreamPlayerSection.classList.remove('flex');
            contentDisplay.style.display = 'grid'; // Show grid for regular tabs
            videoPlayerContainer.classList.add('hidden');
            videoPlayerContainer.classList.remove('flex');

            // Update active tab button style (Blue Underline as requested)
            tabButtons.forEach(btn => {
                // Clear all active/color classes
                btn.classList.remove('border-b-2', 'border-blue-400', 'text-white', 'font-bold');
                btn.classList.add('text-gray-400', 'hover:text-white', 'font-medium'); // Restore default hover/text color

                // Apply activation style for the current tab
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('border-b-2', 'border-blue-400', 'text-white', 'font-bold');
                    btn.classList.remove('text-gray-400', 'hover:text-white', 'font-medium');
                }
            });

            if (tabName === 'n-stream') {
                contentDisplay.style.display = 'none';
                nStreamPlayerSection.classList.remove('hidden');
                nStreamPlayerSection.classList.add('flex');
                loadRecentStreams();
                return;
            }

            // Update loading message with spinner
            contentDisplay.innerHTML = `
                <div class="flex items-center justify-center p-4">
                    <div class="loading-spinner mr-3"></div>
                    <p class="text-center text-gray-400 font-semibold">Loading channels...</p>
                </div>
            `;
            const dataUrl = tabDataUrls[tabName];
            let channelsToDisplay = [];
            try {
                const response = await fetch(dataUrl);
                if (!response.ok) {
                    throw new Error(`HTTP त्रुटि! स्थिति: ${response.status}। सुनिश्चित करें कि JSON फाइल (${dataUrl}) रूट फ़ोल्डर में मौजूद है और पहुंच योग्य है।`);
                }

                if (tabName === 'zee-network') {
                    const data = await response.json();
                    if (data && data.channels) {
                        channelsToDisplay = data.channels;
                    } else {
                        throw new Error('Zee Network के लिए अमान्य डेटा संरचना।');
                    }
                } else if (tabName === 'fancode') {
                    const data = await response.json();
                    if (data && data.matches) {
                        channelsToDisplay = data.matches.map(match => ({
                            name: `${match.event_name}: ${match.match_name}`,
                            logo: match.src || 'https://placehold.co/200x150/2d3748/a0aec0?text=No+Image',
                            mpd: match.dai_url,
                            m3u8: match.adfree_url,
                            clearkey: null,
                            drm: null,
                            customUserAgent: null,
                            customCookies: null
                        }));
                    } else {
                        throw new Error('FanCode के लिए अमान्य डेटा संरचना।');
                    }
                } else if (tabName === 'voot-tv') {
                    // Voot TV JSON mapping
                    const data = await response.json();
                    channelsToDisplay = mapVootTvChannels(data);
                } else if (tabName === 'opplex-tv') {
                    // Opplex TV JSON mapping
                    const data = await response.json();
                    channelsToDisplay = mapOpplexChannels(data);
                } else {
                    const m3uContent = await response.text();
                    channelsToDisplay = await parseM3U(m3uContent);
                }

                displayChannels(channelsToDisplay);
                // Auto-play shared channel
                if (channelToPlay) {
                    const channel = channelsToDisplay.find(c => c.name === channelToPlay);
                    if (channel) {
                        console.log(`Auto-playing shared channel: ${channelToPlay}`);
                        // Delay play slightly to ensure player UI is ready and DOM is updated
                        setTimeout(() => playChannel(channel), 100);
                    } else {
                        console.warn(`Shared channel "${channelToPlay}" not found in tab "${tabName}".`);
                    }
                }
            } catch (error) {
                console.error('डेटा लोड करने में त्रुटि:', error);
                contentDisplay.innerHTML = `<p class="text-center text-red-400 p-4 font-semibold">सामग्री लोड करने में त्रुटि हुई: ${error.message}</p>`;
            }
        }

        // --- Quality Selector Logic ---
        function setupShakaQualitySelector() {
            if (!shakaPlayerInstance) return;

            const tracks = shakaPlayerInstance.getVariantTracks();
            qualitySelector.innerHTML = '<option value="auto">स्वचालित</option>';

            // Filter out audio-only tracks and sort by bandwidth (bitrate)
            const videoTracks = tracks.filter(t => t.type === 'variant' && t.height > 0).sort((a, b) => b.bandwidth - a.bandwidth);

            videoTracks.forEach(track => {
                const option = document.createElement('option');
                option.value = track.id;
                // Displaying resolution and bitrate
                option.textContent = `${track.height}p (${Math.round(track.bandwidth / 1000)} Kbps)`;
                qualitySelector.appendChild(option);
            });

            if (videoTracks.length > 1) {
                qualitySelector.classList.remove('hidden');
            } else {
                qualitySelector.classList.add('hidden');
            }

            // Set initial selection to the active track or auto
            const activeTrack = shakaPlayerInstance.getVariantTracks().find(t => t.active);
            qualitySelector.value = activeTrack ? activeTrack.id : 'auto';
        }
        
        // --- Recent Streams Logic ---
        function getRecentStreams() {
            try {
                const streams = JSON.parse(localStorage.getItem('recentNStreams') || '[]');
                return Array.isArray(streams) ? streams : [];
            } catch (e) {
                console.error("Error parsing recent streams from localStorage:", e);
                return [];
            }
        }

        function clearRecentStreams() {
            try {
                localStorage.removeItem('recentNStreams');
                console.log('Recent streams cleared.');
                loadRecentStreams(); // Refresh the display
            } catch (e) {
                console.error("Error clearing recent streams:", e);
            }
        }

        function saveRecentStream(channelConfig) {
            const maxStreams = 5;
            let streams = getRecentStreams();

            // Create a unique key for the stream based on its primary URL
            const url = channelConfig.mpd || channelConfig.m3u8;
            if (!url) return;

            // Remove sensitive DRM keys and keep only required fields for history
            const simpleConfig = {
                mpd: channelConfig.mpd,
                m3u8: channelConfig.m3u8,
                clearkey: channelConfig.clearkey ? { keyId: channelConfig.clearkey.keyId, key: channelConfig.clearkey.key } : null,
                drm: channelConfig.drm ? { licenseUrl: channelConfig.drm.licenseUrl } : null
            };

            // Remove existing stream with the same URL to put the new one at the front
            streams = streams.filter(s => (s.mpd || s.m3u8) !== url);

            // Add new stream to the front
            streams.unshift(simpleConfig);

            // Keep only the maxStreams number
            streams = streams.slice(0, maxStreams);

            try {
                localStorage.setItem('recentNStreams', JSON.stringify(streams));
                loadRecentStreams(); // Refresh the list
            } catch (e) {
                console.error("Error saving recent streams to localStorage:", e);
            }
        }

        function loadRecentStreams() {
            const streams = getRecentStreams();
            recentStreamsList.innerHTML = '';

            if (streams.length === 0) {
                recentStreamsList.innerHTML = `<p id="no-recent-streams" class="text-sm text-gray-500">कोई हालिया स्ट्रीम नहीं।</p>`;
                clearRecentStreamsBtn.classList.add('hidden'); // Hide button
                return;
            }

            clearRecentStreamsBtn.classList.remove('hidden'); // Show button

            streams.forEach(stream => {
                const streamUrl = stream.mpd || stream.m3u8 || 'N/A';
                const type = stream.mpd ? 'DASH' : 'HLS';
                const keyId = stream.clearkey ? stream.clearkey.keyId : '';
                const key = stream.clearkey ? stream.clearkey.key : '';
                const licenseUrl = stream.drm ? stream.drm.licenseUrl : '';

                const button = document.createElement('button');
                button.classList.add('bg-gray-700', 'hover:bg-gray-600', 'text-white', 'py-2', 'px-3', 'rounded-lg', 'text-sm', 'transition-all', 'duration-200', 'shadow-md', 'flex', 'flex-col', 'items-start');

                button.innerHTML = `
                    <span class="font-semibold text-blue-300">${type} Stream</span>
                    <span class="text-xs text-gray-400 recent-stream-url" title="${streamUrl}">${streamUrl}</span>
                `;

                button.addEventListener('click', () => {
                    // Pre-fill N-Stream inputs
                    streamUrlInput.value = streamUrl;
                    streamTypeSelect.value = type;
                    clearkeyIdInput.value = keyId;
                    clearkeyKeyInput.value = key;
                    drmLicenseUrlInput.value = licenseUrl;

                    // Trigger change event to show/hide DRM controls
                    const changeEvent = new Event('change');
                    streamTypeSelect.dispatchEvent(changeEvent);

                    // Play the stream directly
                    playNStreamBtn.click();
                });

                recentStreamsList.appendChild(button);
            });
        }
        
        // --- Event Listeners and Initialization ---

        // Player Event Listeners
        closePlayerBtn.addEventListener('click', closePlayer);
        shareBtn.addEventListener('click', () => {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                showMessageBox("सफलतापूर्वक साझा किया गया", "चैनल लिंक क्लिपबोर्ड पर कॉपी कर लिया गया है!");
            }).catch(err => {
                showMessageBox("कॉपी करने में त्रुटि", "लिंक को कॉपी करने में असमर्थ। कृपया URL को मैन्युअल रूप से कॉपी करें।");
                console.error('Could not copy text: ', err);
            });
        });
        qualitySelector.addEventListener('change', (e) => {
            if (!shakaPlayerInstance) return;
            const trackId = e.target.value;
            if (trackId === 'auto') {
                shakaPlayerInstance.configure({ abr: { enabled: true } });
            } else {
                shakaPlayerInstance.configure({ abr: { enabled: false } });
                const track = shakaPlayerInstance.getVariantTracks().find(t => t.id == trackId);
                if (track) {
                    shakaPlayerInstance.selectVariantTrack(track, true);
                }
            }
        });
        
        // Modal Event Listeners
        messageBoxCloseBtn.addEventListener('click', closeMessageBox);
        infoBtn.addEventListener('click', openInfoModal);
        infoModalCloseBtn.addEventListener('click', closeInfoModal);

        // Tab button event listeners
        tabButtons.forEach(button => {
            button.addEventListener('click', (event) => {
                const tab = event.target.dataset.tab;

                // Update URL for tab selection, remove channel/n
                updateQueryParam('tab', tab);
                updateQueryParam('channel', null);
                updateQueryParam('n', null);
                localStorage.setItem('activeTab', tab);

                loadAndDisplayChannels(tab);
            });
        });

        // Search bar logic
        const searchBars = document.querySelectorAll('.search-bar');
        searchBars.forEach(searchBar => {
            searchBar.addEventListener('input', (event) => {
                const searchTerm = event.target.value.toLowerCase();
                if (nStreamPlayerSection.classList.contains('flex')) {
                    return;
                }
                const filteredChannels = currentLoadedChannels.filter(channel =>
                    channel.name.toLowerCase().includes(searchTerm)
                );
                displayChannels(filteredChannels);
            });
        });

        // N Stream specific logic
        streamTypeSelect.addEventListener('change', () => {
            if (streamTypeSelect.value === 'DASH') {
                drmControls.classList.remove('hidden');
                drmControls.classList.add('flex');
            } else {
                drmControls.classList.add('hidden');
                drmControls.classList.remove('flex');
                clearkeyIdInput.value = '';
                clearkeyKeyInput.value = '';
                drmLicenseUrlInput.value = '';
            }
        });

        // Clear recent streams button listener
        clearRecentStreamsBtn.addEventListener('click', clearRecentStreams);

        playNStreamBtn.addEventListener('click', () => {
            const streamUrl = streamUrlInput.value.trim();
            const streamType = streamTypeSelect.value;

            let channelConfig = {
                name: 'N Stream Custom Playback',
                logo: '',
                mpd: null,
                m3u8: null,
                clearkey: null,
                drm: null
                // Note: customUserAgent and customCookies are NOT supported for manual N Stream as per previous user request.
            };

            if (!streamUrl) {
                console.error('कृपया स्ट्रीम URL डालें।');
                showMessageBox("URL आवश्यक", "कृपया 'स्ट्रीम URL' इनपुट फ़ील्ड में एक मान्य पता डालें।");
                return;
            }

            if (streamType === 'HLS') {
                channelConfig.m3u8 = streamUrl;
            } else if (streamType === 'DASH') {
                channelConfig.mpd = streamUrl;
                const clearkeyId = clearkeyIdInput.value.trim();
                const clearkeyKey = clearkeyKeyInput.value.trim();
                const drmLicenseUrl = drmLicenseUrlInput.value.trim();

                if (clearkeyId && clearkeyKey) {
                    channelConfig.clearkey = {
                        keyId: clearkeyId,
                        key: clearkeyKey
                    };
                }
                if (drmLicenseUrl) {
                    channelConfig.drm = {
                        type: 'widevine',
                        licenseUrl: drmLicenseUrl
                    };
                }
            }

            // Play the channel. No custom headers needed now for N Stream.
            playChannel(channelConfig);

            // Save to recent streams after successful attempt
            saveRecentStream(channelConfig);

            // Update sharable URL for N-Stream
            updateNStreamShareableUrl(channelConfig);
        });
        
        // --- Initialization on DOMContentLoaded (Handles Shared URLs) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Shaka Player (must be done before playing a DASH stream)
            initShakaPlayer(); 
            
            const urlParams = new URLSearchParams(window.location.search);
            const nParam = urlParams.get('n');
            const sharedTab = urlParams.get('tab');
            const sharedChannel = urlParams.get('channel');

            let tabToActivate = sharedTab || localStorage.getItem('activeTab') || 'pere-sports';

            // Case 1: Shared N-Stream URL
            if (nParam) {
                tabToActivate = 'n-stream';
                const nValue = decodeURIComponent(nParam);

                let streamUrl = nValue;
                let clearkeyId = '';
                let clearkeyKey = '';
                let drmLicenseUrl = '';
                let streamType = 'HLS';

                // Split URL from parameters
                const parts = nValue.split('|');
                streamUrl = parts[0];

                if (parts.length > 1) {
                    const params = new URLSearchParams(parts[1]);

                    // DRM/ClearKey Parsing
                    const drmScheme = params.get('drmScheme');
                    if (drmScheme === 'clearkey') {
                        const license = params.get('drmLicense');
                        if (license) {
                            const [kid, key] = license.split(':');
                            clearkeyId = kid;
                            clearkeyKey = key;
                            streamType = 'DASH';
                        }
                    } else if (drmScheme === 'widevine') {
                        drmLicenseUrl = params.get('drmLicense');
                        streamType = 'DASH';
                    }
                } else if (streamUrl.includes('.mpd')) {
                    streamType = 'DASH';
                }

                const nStreamTabButton = document.querySelector('.tab-button[data-tab="n-stream"]');
                if (nStreamTabButton) {
                    // Manually set tab and update URL, then proceed with N-Stream logic
                    currentTab = 'n-stream';
                    updateQueryParam('tab', 'n-stream');
                    loadAndDisplayChannels('n-stream'); // Load N-Stream section

                    // Populate inputs and play after a short delay
                    setTimeout(() => {
                        streamUrlInput.value = streamUrl;
                        streamTypeSelect.value = streamType;

                        const changeEvent = new Event('change');
                        streamTypeSelect.dispatchEvent(changeEvent);

                        clearkeyIdInput.value = clearkeyId;
                        clearkeyKeyInput.value = clearkeyKey;
                        drmLicenseUrlInput.value = drmLicenseUrl;

                        playNStreamBtn.click(); // Auto-play the stream
                    }, 100);
                }
            }
            // Case 2: Shared Regular Channel URL
            else if (sharedTab && sharedChannel) {
                const tabButton = document.querySelector(`.tab-button[data-tab="${sharedTab}"]`);
                if (tabButton) {
                    // Directly load the tab and pass the channel name for auto-play
                    // We don't need to 'click' the button, just call the loader
                    loadAndDisplayChannels(sharedTab, decodeURIComponent(sharedChannel));
                }
            }
            // Case 3: Default/Saved Tab Load
            else {
                const defaultButton = document.querySelector(`.tab-button[data-tab="${tabToActivate}"]`);
                if (defaultButton) {
                    // Directly load the tab
                    loadAndDisplayChannels(tabToActivate);
                } else {
                    // Fallback to Jio TV if default/saved tab not found
                    loadAndDisplayChannels('jio-tv');
                }
            }
        });
    </script>
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "68a40879f6b244629841d4be7aec5e0f"}'></script><!-- End Cloudflare Web Analytics -->
</body>
</html>
